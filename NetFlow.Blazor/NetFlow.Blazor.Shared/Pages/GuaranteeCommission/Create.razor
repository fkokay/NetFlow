@page "/guarantee-commission/add/{GuaranteeId:int}"
@inject NavigationManager NavigationManager
@inject IApiClientFactory ApiClientFactory
@inject IHttpClientFactory HttpClientFactory

<div class="content-root">
    <div class="card toolbar">
        <DxToolbar ItemRenderStyleMode="ToolbarRenderStyleMode.Plain">
            <Items>
                <DxToolbarItem IconCssClass="back-icon icon medium-icon" Tooltip="Geri Dön" Click="@NavigateBack" />
                <DxToolbarItem>
                    <Template>
                        <div class="custom-item">
                            <div class="title">Yeni Komisyon Tanımlama</div>
                        </div>
                    </Template>
                </DxToolbarItem>
                <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                    <Template>
                        <DxButton Text="Kaydet"
                                  Click="SaveFromOutside"
                                  RenderStyleMode="ButtonRenderStyleMode.Outline"
                                  RenderStyle="ButtonRenderStyle.Success" />
                    </Template>
                </DxToolbarItem>
            </Items>
        </DxToolbar>
    </div>

    <div class="commission-create">
        <EditForm EditContext="@editContext" Context="formContext">
            <DataAnnotationsValidator />

            <DxFormLayout ColSpanMd="6">

                <DxFormLayoutItem Caption="Başlangıç Tarihi">
                    <DxDateEdit @bind-Date="model.CommissionStartDate"
                                ValidationEnabled="true"
                                ShowValidationIcon="true" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Bitiş Tarihi">
                    <DxDateEdit @bind-Date="model.CommissionEndDate"
                                ValidationEnabled="true"
                                ShowValidationIcon="true" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Komisyon Oranı (%)">
                    <DxSpinEdit @bind-Value="model.CommissionRate"
                                ShowValidationIcon="true"
                                DisplayFormat="N4" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Komisyon Tutarı">
                    <DxSpinEdit @bind-Value="model.CommissionAmount"
                                ShowValidationIcon="true"
                                DisplayFormat="N2" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Para Birimi">
                    <DxTextBox @bind-Text="model.Currency" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Ödeme Durumu">
                    <DxComboBox Data="@(new List<string> { "Beklemede", "Ödendi", "İptal" })"
                                @bind-Value="model.PaymentStatus" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Ödeme Tarihi">
                    <DxDateEdit @bind-Date="model.PaymentDate" ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Banka Ref. No">
                    <DxTextBox @bind-Text="model.BankReferenceNo" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Not / Açıklama" ColSpanMd="12">
                    <DxMemo @bind-Text="model.Note" Rows="3" />
                </DxFormLayoutItem>

                <DxFormLayoutItem ColSpanMd="12">
                    <ValidationSummary />
                </DxFormLayoutItem>

            </DxFormLayout>
        </EditForm>
    </div>
</div>


<DxPopup @bind-Visible="popupVisible"
         HeaderText="@popupTitle"
         Width="420px"
         ShowFooter="true"
         CloseOnOutsideClick="false"
         HeaderCssClass="@(isSuccess ? "dx-bg-success" : "dx-bg-danger")"
         AnimationType="PopupAnimationType.Fade">
    <HeaderTemplate>
        <div class="@(isSuccess ? "popup-header-success" : "popup-header-danger")">
            <span class="popup-header-title">@popupTitle</span>
        </div>
    </HeaderTemplate>
    <BodyTemplate>
        <div class="popup-body">
            <div class="popup-icon-wrapper">
                @if (isSuccess)
                {
                    <div class="popup-icon popup-icon-success">✓</div>
                }
                else
                {

                    <div class="popup-icon popup-icon-danger">!</div>
                }
            </div>
            <div class="popup-content">
                <h5 class="popup-title">@(isSuccess ? "İşlem Tamamlandı" : "Bir Hata Oluştu")</h5>
                <p class="popup-message">@popupMessage</p>
            </div>
        </div>
    </BodyTemplate>
    <FooterTemplate>
        <div class="popup-footer">
            <DxButton Text="Kapat"
                      RenderStyle="@(isSuccess ? ButtonRenderStyle.Success : ButtonRenderStyle.Danger)"
                      Click="OnPopupOk"
                      Width="110px" />
        </div>
    </FooterTemplate>
</DxPopup>

@code {
    [Parameter] public int GuaranteeId { get; set; }

    private GuaranteeCommissionModel model = new();
    private EditContext editContext = default!;
    private bool isSaving, popupVisible, isSuccess;
    private string popupTitle = "", popupMessage = "";

    protected override void OnInitialized()
    {
        model.GuaranteeId = GuaranteeId;
        model.CommissionStartDate = DateTime.Now;
        model.CommissionEndDate = DateTime.Now.AddMonths(3);
        editContext = new EditContext(model);
    }

    private async Task SaveFromOutside()
    {
        if (isSaving) return;
        if (editContext.Validate())
        {
            await HandleValidSubmit();
        }
    }

    private async Task HandleValidSubmit()
    {
        isSaving = true;
        try
        {
            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            var client = await ApiClientFactory.CreateAsync(httpClient);

            var response = await client.PostAsJsonAsync("api/guarantee-commissions", model);

            if (response.IsSuccessStatusCode)
            {
                isSuccess = true;
                popupTitle = "Başarılı";
                popupMessage = "Komisyon kaydı başarıyla oluşturuldu.";
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                isSuccess = false;
                popupTitle = "Hata";
                popupMessage = error;
            }
        }
        catch (Exception ex)
        {
            isSuccess = false;
            popupTitle = "Bağlantı Hatası";
            popupMessage = ex.Message;
        }
        finally
        {
            popupVisible = true;
            isSaving = false;
        }
    }

    private void OnPopupOk()
    {
        popupVisible = false;
        if (isSuccess) NavigateBack();
    }

    private void NavigateBack() => NavigationManager.NavigateTo($"/guarantee/details/{GuaranteeId}");
}