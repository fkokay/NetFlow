@page "/firm/list"
@implements IDisposable
@inject NavigationManager NavigationManager
@inject IApiClientFactory ApiClientFactory
@inject IHttpClientFactory HttpClientFactory

<div class="content-root">
    <div class="card toolbar">
        <DxToolbar Title="Firma Listesi" ItemRenderStyleMode="ToolbarRenderStyleMode.Plain">
            <DxToolbarItem Text="Yeni Firma" Click="OnAddClick" Alignment="ToolbarItemAlignment.Right" IconCssClass="add-icon icon medium-icon" />
            <DxToolbarItem Tooltip="Sütun Seçici" Alignment="ToolbarItemAlignment.Right" Click="OnColumnChooserItemClick" IconCssClass="column-chooser-icon icon medium-icon" />
            <DxToolbarItem Text="Dışarı Aktar" Alignment="ToolbarItemAlignment.Right" IconCssClass="export-icon icon medium-icon">
                <Items>
                    <DxToolbarItem Text="Excel'e Aktar" Click="ExportAllDataToExcel" />
                    <DxToolbarItem Text="Seçili Satırları Excel'e Aktar" Click="ExportSelectedRowsToExcel" />
                    <DxToolbarItem Text="CSV'ye Aktar" Click="ExportAllDataToCsv" />
                    <DxToolbarItem Text="PDF'e Aktar" Click="ExportAllDataToPdf" />
                </Items>
            </DxToolbarItem>
            <DxToolbarItem Alignment="ToolbarItemAlignment.Right" CssClass="search-textbox-item" Tooltip="Ara">
                <Template Context="SearchContext">
                    <div class="custom-item">
                        <DxSearchBox CssClass="search-textbox"
                                     NullText="Ara..."
                                     BindValueMode="BindValueMode.OnInput"
                                     ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                     @bind-Text=SearchText />
                    </div>
                </Template>
            </DxToolbarItem>
            <DxToolbarItem Tooltip="Yenile" Click="LoadGridDataAsync" BeginGroup="true" Alignment="ToolbarItemAlignment.Right" IconCssClass="refresh-icon icon medium-icon" />
        </DxToolbar>
    </div>
    <div class="Firm-list-root">
        <div class="h-100">
            <DxGrid @ref="Grid"
                    Data="Data"
                    KeyFieldName="Id"
                    CssClass="Firm-list"
                    SearchText="@SearchText"
                    EditMode="GridEditMode.PopupEditForm"
                    PopupEditFormCssClass="pw-800"
                    SkeletonRowsEnabled="true"
                    ColumnResizeMode="GridColumnResizeMode.NextColumn"
                    FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
                    TextWrapEnabled="false"
                    FocusedRowEnabled="true"
                    ShowAllRows="true"
                    VirtualScrollingEnabled="true"
                    RowClick="@OnRowClick"
                    HighlightRowOnHover="true"
                    DataItemDeleting="Grid_DataItemDeleting"
                    CustomizeEditModel="Grid_CustomizeEditModel">
                <Columns>
                    <DxGridSelectionColumn Width="75px" />
                    <DxGridDataColumn Caption="Id" FieldName="Id" Visible="false" />
                    <DxGridDataColumn Caption="Firma Kodu" FieldName="FirmCode" />
                    <DxGridDataColumn Caption="Firma Adı" FieldName="FirmName" />
                    <DxGridCommandColumn Width="6em" DeleteButtonVisible="true" EditButtonVisible="true" />
                </Columns>
                <GroupSummary>
                    <DxGridSummaryItem FieldName="Id" SummaryType="GridSummaryItemType.Count" />
                </GroupSummary>
                <TotalSummary>
                    <DxGridSummaryItem FieldName="Id" SummaryType="GridSummaryItemType.Count" FooterColumnName="Id" />
                </TotalSummary>
            </DxGrid>
        </div>
    </div>
</div>
<DxPopup @bind-Visible="popupVisible" Width="460px" ShowFooter="true" CloseOnOutsideClick="false">
    <HeaderTemplate>
        <div style="background: @(isSuccess ? "linear-gradient(90deg,#28a745,#218838)" : "linear-gradient(90deg,#dc3545,#b02a37)"); color:white; padding:14px 18px; width:100%; display:flex; align-items:center; gap:12px;">
            <div style="width:36px;height:36px;border-radius:50%; background:rgba(255,255,255,0.2); display:flex;align-items:center;justify-content:center; font-size:20px;font-weight:bold;">
                @(isSuccess ? "✓" : "!")
            </div>
            <div>
                <div style="font-size:1.05rem;font-weight:600;">@(isSuccess ? "İşlem Başarılı" : "İşlem Hatası")</div>
                <div style="font-size:12px;opacity:.85">@popupTitle</div>
            </div>
        </div>
    </HeaderTemplate>
    <BodyTemplate>
        <div style="padding:28px 26px;display:flex;gap:20px;">
            <div style="width:60px;height:60px;border-radius:50%; background-color:@(isSuccess ? "#e9f7ef" : "#fdeaea"); color:@(isSuccess ? "#28a745" : "#dc3545"); display:flex;align-items:center;justify-content:center; font-size:28px;font-weight:bold;">
                @(isSuccess ? "✓" : "!")
            </div>
            <div style="flex:1;">
                <h5 style="margin:0 0 6px 0;font-weight:600;color:#222;">@(isSuccess ? "Bilgiler Güncellendi" : "Hata Oluştu")</h5>
                <p style="margin:0;color:#555;font-size:14px;line-height:1.6;">@popupMessage</p>
            </div>
        </div>
    </BodyTemplate>
    <FooterTemplate>
        <div style="padding:14px 18px; display:flex; justify-content:flex-end; border-top:1px solid #eee; background:#fafafa; width:100%;">
            <DxButton Text="Kapat" Width="130px" RenderStyle="@(isSuccess? ButtonRenderStyle.Success: ButtonRenderStyle.Danger)" Click="OnPopupOk" />
        </div>
    </FooterTemplate>
</DxPopup>

@code {
    CancellationTokenSource disposalTokenSource = new CancellationTokenSource();

    [CascadingParameter(Name = "ParentSizeMode")]
    GridDevExtremeDataSource<FirmModel> Data { get; set; } = null!;
    IGrid? Grid { get; set; }
    string? SearchText { get; set; }
    SizeMode SizeMode { get; set; }
    private bool popupVisible, isSuccess;
    private string popupTitle = "", popupMessage = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        await LoadGridDataAsync();
    }

    async Task LoadGridDataAsync()
    {
        var httpClient = HttpClientFactory.CreateClient("ApiClient");
        var client = await ApiClientFactory.CreateAsync(httpClient);
        Data = new GridDevExtremeDataSource<FirmModel>(client, NavigationManager.ToAbsoluteUri("https://localhost:7071/api/firms"));

        if (Grid != null) Grid.Reload();
        await InvokeAsync(StateHasChanged);
    }

    void OnAddClick() => NavigationManager.NavigateTo("/firm/create");

    void Grid_CustomizeEditModel(GridCustomizeEditModelEventArgs e)
    {
        if (e.IsNew)
        {
            NavigationManager.NavigateTo("/firm/create");
        }
        else
        {
            var firm = (FirmModel)e.DataItem;
            NavigationManager.NavigateTo($"/firm/edit/{firm.Id}");
        }
    }

    async Task OnRowClick(GridRowClickEventArgs args){}

    async Task Grid_DataItemDeleting(GridDataItemDeletingEventArgs e)
    {
        e.Cancel = true;
        var firm = (FirmModel)e.DataItem;

        try
        {
            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            var client = await ApiClientFactory.CreateAsync(httpClient);
            var response = await client.DeleteAsync($"api/firms/{firm.Id}");

            if (response.IsSuccessStatusCode)
            {
                isSuccess = true;
                popupTitle = "Silme Başarılı";
                popupMessage = $"{firm.FirmName} isimli firma sistemden silindi.";

                await LoadGridDataAsync();
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                isSuccess = false;
                popupTitle = "Silme Hatası";
                popupMessage = string.IsNullOrEmpty(errorMsg) ? "Bu kayıt silinemez. Diğer verilerle ilişkili olabilir." : errorMsg;
            }
        }
        catch (Exception ex)
        {
            isSuccess = false;
            popupTitle = "Bağlantı Hatası";
            popupMessage = "Silme işlemi sırasında sunucuya ulaşılamadı: " + ex.Message;
        }
        finally
        {
            popupVisible = true;
            StateHasChanged();
        }
    }
    private void OnPopupOk()
    {
        popupVisible = false;
        if (isSuccess)
            NavigationManager.NavigateTo("/firm/list");
    }
    void OnColumnChooserItemClick(ToolbarItemClickEventArgs e) => Grid!.ShowColumnChooser();
    Task ExportAllDataToExcel() => Grid!.ExportToXlsxAsync("Firms");
    Task ExportSelectedRowsToExcel() => Grid!.ExportToXlsxAsync("Selected Firms", new GridXlExportOptions { ExportSelectedRowsOnly = true });
    Task ExportAllDataToCsv() => Grid!.ExportToCsvAsync("Firms");
    Task ExportSelectedRowsDataToCsv() => Grid!.ExportToCsvAsync("Selected Firms", new GridCsvExportOptions { ExportSelectedRowsOnly = true });
    Task ExportAllDataToPdf() => Grid!.ExportToPdfAsync("Firms");
    Task ExportSelectedRowsDataToPdf() => Grid!.ExportToPdfAsync("Selected Firms", new GridPdfExportOptions { ExportSelectedRowsOnly = true });

    void IDisposable.Dispose()
    {
        disposalTokenSource.Cancel();
        disposalTokenSource.Dispose();
    }
}