@using System.Net.Http.Json
@using System.Threading.Tasks
@inject IHttpClientFactory HttpClientFactory
@inject IApiClientFactory ApiClientFactory
@inject IToastNotificationService ToastService

<DxPopup @bind-Visible="@IsExtensionPopupVisible" ShowFooter="true" HeaderText="Teminat Süresini Uzat" Width="600px">
    <BodyContentTemplate Context="PopupContext">
        <DxFormLayout CaptionPosition="CaptionPosition.Horizontal">
            <DxFormLayoutItem Caption="Teminat No" ColSpanMd="12">
                <DxTextBox Text="@Guarantee.GuaranteeNumber" ReadOnly="true" />
            </DxFormLayoutItem>

            <DxFormLayoutItem Caption="Konu" ColSpanMd="12">
                <DxTextBox Text="@Guarantee.Subject" ReadOnly="true" />
            </DxFormLayoutItem>

            <DxFormLayoutItem ColSpanMd="12">
                <Template>
                    <div class="form-separator"></div>
                </Template>
            </DxFormLayoutItem>

            <DxFormLayoutItem Caption="Başlangıç Tarihi" ColSpanMd="12">
                <DxDateEdit Date="@Guarantee.GuaranteeDate" ReadOnly="true" Mask="@DateTimeMask.ShortDate" />
            </DxFormLayoutItem>

            <DxFormLayoutItem Caption="Bitiş(Vade) Tarihi" ColSpanMd="12">
                <DxDateEdit Date="@Guarantee.ExpiryDate" ReadOnly="true" Mask="@DateTimeMask.ShortDate" />
            </DxFormLayoutItem>

            <DxFormLayoutItem Caption="Yeni Bitiş(Vade) Tarihi" ColSpanMd="12" CssClass="highlight-item">
                <ChildContent Context="itemContext">
                    <DxDateEdit @bind-Date="@NewExpiryDate" PickerDisplayMode="DatePickerDisplayMode.Calendar" Mask="@DateTimeMask.ShortDate" />
                </ChildContent>
            </DxFormLayoutItem>
        </DxFormLayout>
    </BodyContentTemplate>

    <FooterContentTemplate>
        <DxButton RenderStyle="ButtonRenderStyle.Primary" Text="Kaydet" IconCssClass="dx-icon-save" Click="OnSave" />

        <DxButton RenderStyle="ButtonRenderStyle.Secondary" Text="Vazgeç" IconCssClass="dx-icon-close" Click="OnCancel" />
    </FooterContentTemplate>
</DxPopup>


@code {
    [Parameter] public required GuaranteeModel Guarantee { get; set; }
    [Parameter] public required bool IsExtensionPopupVisible { get; set; } = false;
    [Parameter] public EventCallback OnSaved { get; set; }
    [Parameter] public EventCallback OnCanceled { get; set; }

    private DateTime NewExpiryDate { get; set; }

    private async Task OnCancel()
    {
        IsExtensionPopupVisible = false;

        if (OnCanceled.HasDelegate)
            await OnCanceled.InvokeAsync();
    }

    private async Task OnSave()
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            var client = await ApiClientFactory.CreateAsync(httpClient);

            var model = new { Id = Guarantee.Id, ExpiryDate = NewExpiryDate };
            var response = await client.PutAsJsonAsync($"https://localhost:7071/api/guarantees/extension", model);

            if (response.IsSuccessStatusCode)
            {
                ToastService.ShowToast(new ToastOptions()
                {
                    Id = "toast",
                    ProviderName = "Overview",
                    ThemeMode = ToastThemeMode.Light,
                    RenderStyle = ToastRenderStyle.Success,
                    Title = "Başarılı",
                    Text = "Teminat süresi başarılı bir şekilde uzatıldı."
                }, RenderToastButton(false));
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                ToastService.ShowToast(new ToastOptions()
                {
                    Id = "toast",
                    ProviderName = "Overview",
                    ThemeMode = ToastThemeMode.Light,
                    RenderStyle = ToastRenderStyle.Warning,
                    Title = "Hata",
                    Text = string.IsNullOrWhiteSpace(errorMsg) ? "Teminat süresi uzatılırken hata oluştu." : errorMsg
                }, RenderToastButton(true));
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast(new ToastOptions()
            {
                Id = "toast",
                ProviderName = "Overview",
                ThemeMode = ToastThemeMode.Light,
                RenderStyle = ToastRenderStyle.Warning,
                Title = "Hata",
                Text = string.IsNullOrWhiteSpace(ex.Message) ? "Beklenmedik bir hata oluştu." : ex.Message
            }, RenderToastButton(true));
        }
    }

    private RenderFragment RenderToastButton(bool isError)
    {
        return  @<div class="d-flex gap-2">
                    <DxButton Click="@(isError? OnError : OnSuccess)" RenderStyle="@(isError? ButtonRenderStyle.Danger: ButtonRenderStyle.Success)">Kapat</DxButton>
                </div>;
    }

    private async Task OnSuccess()
    {
        IsExtensionPopupVisible = false;

        if (OnCanceled.HasDelegate)
            await OnCanceled.InvokeAsync();
    }

    private async Task OnError()
    {
        if (OnCanceled.HasDelegate)
            await OnCanceled.InvokeAsync();
    }
}
