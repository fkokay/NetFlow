@using System.Net.Http.Json
@inject IHttpClientFactory HttpClientFactory
@inject IApiClientFactory ApiClientFactory
@inject IToastNotificationService ToastService

<DxPopup @bind-Visible="Visible"
         ShowFooter="true"
         HeaderText="Teminat Süresini Uzat"
         Width="600px"
         MaxWidth="95vw">

    <BodyContentTemplate Context="popupCtx">
        @if (Visible && Guarantee != null)
        {
            <div class="extension-popup-container">
                @* DxFormLayout için de bir context ismi veriyoruz *@
                <DxFormLayout Context="formCtx" CaptionPosition="CaptionPosition.Horizontal">

                    <DxFormLayoutItem Caption="Teminat No" ColSpanMd="12">
                        @* KRİTİK NOKTA: ChildContent'i açıkça yazıp 
                           Context ismini değiştiriyoruz 
                        *@
                        <ChildContent Context="itemCtx1">
                            <DxTextBox Text="@Guarantee.GuaranteeNumber" ReadOnly />
                        </ChildContent>
                    </DxFormLayoutItem>

                    <DxFormLayoutItem Caption="Konu" ColSpanMd="12">
                        <ChildContent Context="itemCtx2">
                            <DxTextBox Text="@Guarantee.Subject" ReadOnly />
                        </ChildContent>
                    </DxFormLayoutItem>

                    <DxFormLayoutItem Caption="Başlangıç Tarihi" ColSpanMd="12">
                        <ChildContent Context="itemCtx3">
                            <DxDateEdit Date="@Guarantee.GuaranteeDate"
                                        ReadOnly
                                        Mask="@DateTimeMask.ShortDate" />
                        </ChildContent>
                    </DxFormLayoutItem>

                    <DxFormLayoutItem Caption="Mevcut Vade" ColSpanMd="12">
                        <ChildContent Context="itemCtx4">
                            <DxDateEdit Date="@Guarantee.ExpiryDate"
                                        ReadOnly
                                        Mask="@DateTimeMask.ShortDate" />
                        </ChildContent>
                    </DxFormLayoutItem>

                    <DxFormLayoutItem Caption="Yeni Vade Tarihi"
                                      ColSpanMd="12"
                                      CssClass="highlight-item">
                        <ChildContent Context="itemCtx5">
                            <DxDateEdit @bind-Date="NewExpiryDate"
                                        PickerDisplayMode="DatePickerDisplayMode.Calendar"
                                        Mask="@DateTimeMask.ShortDate" />
                        </ChildContent>
                    </DxFormLayoutItem>

                </DxFormLayout>
            </div>
        }
    </BodyContentTemplate>

    <FooterContentTemplate Context="footerCtx">
        <DxButton Text="Güncelle ve Onayla"
                  RenderStyle="ButtonRenderStyle.Primary"
                  IconCssClass="dx-icon-save"
                  Enabled="!IsSaving"
                  Click="ConfirmExtension" />

        <DxButton Text="Vazgeç"
                  RenderStyle="ButtonRenderStyle.Secondary"
                  IconCssClass="dx-icon-close"
                  Click="Cancel" />
    </FooterContentTemplate>
</DxPopup>
@code {

    /* -------------------- PARAMETERS -------------------- */

    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }

    [Parameter] public GuaranteeModel? Guarantee { get; set; }

    [Parameter] public string ApiEndpoint { get; set; } = string.Empty;

    /// <summary>
    /// Uzatma işlemi başarılı olunca parent tetiklenir (grid reload vs.)
    /// </summary>
    [Parameter] public EventCallback OnSuccess { get; set; }

    /* -------------------- STATE -------------------- */

    private DateTime NewExpiryDate;
    private bool IsSaving;

    /* -------------------- LIFECYCLE -------------------- */

    protected override void OnParametersSet()
    {
        if (Guarantee != null)
            NewExpiryDate = Guarantee.ExpiryDate;
    }

    /* -------------------- ACTIONS -------------------- */

    private async Task ConfirmExtension()
    {
        if (Guarantee == null || IsSaving)
            return;

        IsSaving = true;

        try
        {
            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            var client = await ApiClientFactory.CreateAsync(httpClient);

            var model = new
            {
                Id = Guarantee.Id,
                ExpiryDate = NewExpiryDate
            };

            var response = await client.PutAsJsonAsync(
                $"{ApiEndpoint}/extension",
                model
            );

            if (response.IsSuccessStatusCode)
            {
                ToastService.ShowToast(new ToastOptions
                {
                    RenderStyle = ToastRenderStyle.Success,
                    Title = "Başarılı",
                    Text = "Teminat süresi başarıyla uzatıldı."
                });

                await VisibleChanged.InvokeAsync(false);
                await OnSuccess.InvokeAsync();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();

                ToastService.ShowToast(new ToastOptions
                {
                    RenderStyle = ToastRenderStyle.Warning,
                    Title = "Uyarı",
                    Text = string.IsNullOrWhiteSpace(error)
                        ? "Uzatma işlemi başarısız."
                        : error
                });
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast(new ToastOptions
            {
                RenderStyle = ToastRenderStyle.Warning,
                Title = "Hata",
                Text = ex.Message
            });
        }
        finally
        {
            IsSaving = false;
        }
    }

    private async Task Cancel()
    {
        await VisibleChanged.InvokeAsync(false);
    }
}
