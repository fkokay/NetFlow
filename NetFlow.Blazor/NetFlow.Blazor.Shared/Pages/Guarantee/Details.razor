@page "/guarantee/details/{Id:int}"
@using System.Net.Http.Json
@inject NavigationManager NavigationManager
@inject IApiClientFactory ApiClientFactory
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JsRuntime
@inject IToastNotificationService ToastService

<DxLayoutBreakpoint DeviceSize="DeviceSize.XSmall | DeviceSize.Small | DeviceSize.Medium" @bind-IsActive="@IsSmallScreen" />


<DxPopup @bind-Visible="@IsReturnPopupVisible"
         ShowFooter="true"
         HeaderText="İade Et"
         Width="400px"
         MaxWidth="95vw">
    <BodyContentTemplate Context="popupContext">
        @if (IsReturnPopupVisible)
        {
            <div class="rejection-popup-container">
                <DxFormLayout CaptionPosition="CaptionPosition.Vertical">
                    <DxFormLayoutItem Caption="İade Tarihi" ColSpanMd="12">
                        <DxDateEdit @bind-Date="@ReturnDate"
                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                    Format="dd.MM.yyyy"
                                    PickerDisplayMode="DatePickerDisplayMode.Calendar" />

                        @if (ReturnDate == null)
                        {
                            <small class="text-danger mt-1">İade tarihi seçilmesi zorunludur.</small>
                        }
                    </DxFormLayoutItem>
                </DxFormLayout>
            </div>
        }
    </BodyContentTemplate>

    <FooterContentTemplate Context="footerContext">
        <DxButton RenderStyle="ButtonRenderStyle.Primary"
                  Text="İadeyi Onayla"
                  IconCssClass="dx-icon-check"
                  Enabled="@(ReturnDate != null)"
                  Click="OnConfirmReturn" />

        <DxButton RenderStyle="ButtonRenderStyle.Secondary"
                  Text="Vazgeç"
                  IconCssClass="dx-icon-close"
                  Click="OnCancelReturn" />
    </FooterContentTemplate>
</DxPopup>

<div class="content-root">
    <div class="card toolbar">
        <DxToolbar ItemRenderStyleMode="ToolbarRenderStyleMode.Plain">
            <DxToolbarItem IconCssClass="back-icon icon medium-icon"
                           Tooltip="Geri"
                           Click="@NavigateBack" />

            <DxToolbarItem>
                <Template>
                    <div class="custom-item">
                        <div class="title">Teminat Mektubu Detayı</div>
                    </div>
                </Template>
            </DxToolbarItem>
            @if (Model != null)
            {
                

                @if (Model.ReturnDate.HasValue)
                {
                  
                }
                else
                {
                    <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                        <Template>
                            <DxButton Text="İade Et"
                                      class="action-button-return"
                                      Click="@ReturnClick"
                                      RenderStyleMode="ButtonRenderStyleMode.Outline"
                                      RenderStyle="ButtonRenderStyle.Primary" />
                        </Template>
                    </DxToolbarItem>

                    <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                        <Template>
                            <DxButton Text="Düzenle" Click="@OnEditClick" RenderStyleMode="ButtonRenderStyleMode.Outline" RenderStyle="ButtonRenderStyle.Danger" />
                        </Template>
                    </DxToolbarItem>
                    <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                        <Template>
                            <DxButton Text="Sil" Click="@OnDeleteClick" class="action-button-delete" RenderStyleMode="ButtonRenderStyleMode.Outline" RenderStyle="ButtonRenderStyle.Danger" />
                        </Template>
                    </DxToolbarItem>

                    <DxToolbarItem Alignment="ToolbarItemAlignment.Right"
                                   Click="@LoadDataAsync"
                                   Tooltip="Yenile"
                                   IconCssClass="refresh-icon icon medium-icon" />
                }
            
            }
          
           
        </DxToolbar>
    </div>

    <div class="guarantee-details">
        <DxLoadingPanel Visible="@(!IsDataLoaded)"
                        IsContentBlocked="true"
                        IsContentVisible="false"
                        IndicatorVisible="true"
                        IndicatorAreaVisible="true"
                        ZIndex="101"
                        Text="Yükleniyor...">

            <DxGridLayout ColumnSpacing="1rem"
                          RowSpacing="1rem"
                          CssClass="h-100">

                <Columns>
                    @if (!IsSmallScreen)
                    {
                        <DxGridLayoutColumn Width="1fr" />
                        <DxGridLayoutColumn Width="3fr" />
                    }
                    else
                    {
                        <DxGridLayoutColumn Width="100%" />
                    }
                </Columns>

                <Rows>
                    @if (!IsSmallScreen)
                    {
                        <DxGridLayoutRow Areas="item1 item2" />
                    }
                    else
                    {
                        <DxGridLayoutRow Areas="item1" />
                        <DxGridLayoutRow Areas="item2" />
                    }
                </Rows>

                <Items>
                    <DxGridLayoutItem Area="item1">
                        <Template>
                            @if (Model != null)
                            {
                                <div class="card h-100">
                                    <div class="authority-header">

                                        @{
                                            if (@Model.GuaranteeType == "Kati")
                                            {
                                                <div class="authority-avatar">
                                                    @GetAuthorityInitials(Model.PublicAuthorityName)
                                                </div>

                                                <h6 class="authority-title">@Model.PublicAuthorityName</h6>
                                                <span class="authority-badge">
                                                    #@Model.PublicAuthorityCode
                                                </span>
                                            }
                                            else
                                            {
                                                <div class="authority-avatar">
                                                    @GetAuthorityInitials(Model.ExpenseAccountName)
                                                </div>
                                                <h6 class="authority-title">@Model.ExpenseAccountName</h6>
                                                <span class="authority-badge">
                                                   #@Model.ExpenseAccountCode
                                                </span>
                                            }
                                        }
                                    </div>

                                    <div class="guarantee-stats">
                                        <div class="guarantee-stat">
                                            <div class="guarantee-stat-title">@Model.GuaranteeType</div>
                                            <small>Teminat Türü</small>
                                        </div>

                                        <div class="guarantee-stat">
                                            <div class="guarantee-stat-title">
                                                @Model.GuaranteeAmount.ToString("n2")
                                            </div>
                                            <small>@Model.Currency</small>
                                        </div>
                                    </div>

                                    <h6 class="guarantee-section-title">GENEL BİLGİLER</h6>

                                    <div class="guarantee-info">

                                        @if (Model.ReturnDate != null)
                                        {
                                            <div class="guarantee-info-row">
                                                <span>İade Durumu</span>
                                                <span class="guarantee-info-strong text-danger">
                                                    İade Edildi (@Model.ReturnDate.Value.ToShortDateString())
                                                </span>
                                            </div>
                                        }

                                        <div class="guarantee-info-row">
                                            <span>Teminat No</span>
                                            <span class="guarantee-info-strong">#@Model.GuaranteeNumber</span>
                                        </div>

                                        <div class="guarantee-info-row">
                                            <span>Konu</span>
                                            <span class="guarantee-info-strong">@Model.Subject</span>
                                        </div>

                                        <div class="guarantee-info-row">
                                            <span>Firma</span>
                                            <span class="guarantee-info-strong">@Model.FirmName</span>
                                        </div>

                                        <div class="guarantee-info-row">
                                            <span>Teminat Türü</span>
                                            <span class="guarantee-info-strong">@Model.GuaranteeType</span>
                                        </div>

                                        <div class="guarantee-info-row">
                                            <span>Teminat Şekli</span>
                                            <span class="guarantee-info-strong">@Model.GuaranteeForm</span>
                                        </div>

                                        <div class="guarantee-info-row">
                                            <span>Başlangıç Tarihi</span>
                                            <span class="guarantee-info-strong">@Model.GuaranteeDate.ToShortDateString()</span>
                                        </div>

                                        <div class="guarantee-info-row">
                                            <span>Bitiş Tarihi</span>
                                            <span class="guarantee-info-strong @(Model.ExpiryDate <     DateTime.Today ? "text-danger" : "")">
                                                @Model.ExpiryDate.ToShortDateString()
                                            </span>
                                        </div>

                                        <div class="guarantee-info-row">
                                            <span>Kalan Gün</span>
                                            @{
                                                var remainingDays = (Model.ExpiryDate - DateTime.Today).Days;
                                            }
                                            <span class="guarantee-info-strong @(remainingDays < 30 ? "text-danger" : "")">
                                                @remainingDays gün
                                            </span>
                                        </div>

                                        <div class="guarantee-info-row">
                                            <span>Teminat Tutarı</span>
                                            <span class="guarantee-info-strong">
                                                @Model.GuaranteeAmount.ToString("n2") @Model.Currency
                                            </span>
                                        </div>

                                        <div class="guarantee-info-row">
                                            <span>Komisyon</span>
                                            <span class="guarantee-info-strong">
                                                @Model.CommissionAmount.ToString("n2") @Model.Currency
                                            </span>
                                        </div>

                                        <div class="guarantee-info-row">
                                            <span>Komisyon Oranı</span>
                                            <span class="guarantee-info-strong">@Model.CommissionRate.ToString("n4")</span>
                                        </div>

                                        <div class="guarantee-info-row">
                                            <span>Komisyon Dönemi</span>
                                            <span class="guarantee-info-strong">@Model.GuaranteeCommissionPeriodName</span>
                                        </div>

                                        <div class="guarantee-info-row">
                                            <span>Banka / Şube</span>
                                            <span class="guarantee-info-strong">
                                                @Model.BankName - @Model.BankBranchName
                                            </span>
                                        </div>

                                        <div class="guarantee-info-row">
                                            <span>Takasbank Ref.</span>
                                            <span class="guarantee-info-strong">@Model.TakasbankReferenceNo</span>
                                        </div>

                                        <div class="guarantee-info-row">
                                            <span>Oluşturma Tarihi</span>
                                            <span class="guarantee-info-strong">@Model.CreatedAt.ToShortDateString()</span>
                                        </div>

                                    </div>
                                </div>
                            }
                        </Template>
                    </DxGridLayoutItem>

                    <DxGridLayoutItem Area="item2">
                        <Template>
                            <DxTabs CssClass="card tabs"
                                    ActiveTabIndex="@ActiveTabIndex"
                                    ActiveTabIndexChanged="OnActiveTabIndexChanged">

                                <DxTabPage Text="Komisyonlar">
                                    <div class="card toolbar">
                                        <DxToolbar ItemRenderStyleMode="ToolbarRenderStyleMode.Plain">
                                            <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                                                <Template>
                                                    <DxButton Text="Yeni Komisyon Ekle" Click="@GuaranteeCommissionAdd" RenderStyleMode="ButtonRenderStyleMode.Outline" RenderStyle="ButtonRenderStyle.Danger" />
                                                </Template>
                                            </DxToolbarItem>
                                        </DxToolbar>
                                    </div>
                                    <DxGrid Data="CommissionDataSource"
                                            ShowFilterRow="true"
                                            ShowGroupPanel="true"
                                            ColumnResizeMode="GridColumnResizeMode.ColumnsContainer"
                                            EditStart="OnCommissionEditStart"
                                            DataItemDeleting="async (e) => await DeleteCommission(((GuaranteeCommissionModel)e.DataItem).Id)">

                                        <Columns>
                                            <DxGridDataColumn FieldName="@nameof(GuaranteeCommissionModel.CommissionStartDate)" Caption="Başlangıç" />
                                            <DxGridDataColumn FieldName="@nameof(GuaranteeCommissionModel.CommissionEndDate)" Caption="Bitiş" />
                                            <DxGridDataColumn FieldName="@nameof(GuaranteeCommissionModel.CommissionAmount)" Caption="Tutar" DisplayFormat="N2" />
                                            <DxGridDataColumn FieldName="@nameof(GuaranteeCommissionModel.Currency)" Caption="Döviz" />
                                            <DxGridDataColumn FieldName="@nameof(GuaranteeCommissionModel.PaymentStatus)" Caption="Durum" />
                                            <DxGridDataColumn FieldName="@nameof(GuaranteeCommissionModel.Note)" Caption="Açıklama" />

                                            <DxGridCommandColumn Width="120px"
                                                                 EditButtonVisible="true"
                                                                 DeleteButtonVisible="true"
                                                                 NewButtonVisible="false" />
                                        </Columns>
                                    </DxGrid>
                                </DxTabPage>
                            </DxTabs>
                        </Template>
                    </DxGridLayoutItem>
                </Items>
            </DxGridLayout>
        </DxLoadingPanel>
    </div>
</div>

<DxPopup @bind-Visible="@AddPopupVisible"
         ShowFooter="true"
         HeaderText="@(SelectedCommissionId.HasValue ? "Komisyon Düzenle" : "Komisyon Ekle")"
         Width="800px"
         MaxWidth="95vw">

    <BodyContentTemplate>
        @if (AddPopupVisible)
        {
            <GuaranteeCommissionAddComponent @ref="addFormRef"
                                             GuaranteeId="Id"
                                             CommissionId="SelectedCommissionId"
                                             OnSaved="OnCommissionSaved"
                                             OnCancel="OnCommissionCanceled" />
        }
    </BodyContentTemplate>

    <FooterContentTemplate>
        <DxButton CssClass="popup-button my-1 ms-2"
                  RenderStyle="ButtonRenderStyle.Primary"
                  Text="Kaydet"
                  Click="SaveCommissionFromPopup" />

        <DxButton CssClass="popup-button my-1 ms-2"
                  RenderStyle="ButtonRenderStyle.Secondary"
                  Text="Vazgeç"
                  Click="CancelCommissionFromPopup" />
    </FooterContentTemplate>
</DxPopup>


<DxPopup @bind-Visible="@DeleteConfirmationVisible"
         HeaderText="Silme Onayı"
         Width="400px"
         ShowFooter="true"
         CssClass="delete-confirmation-popup">
    <BodyContentTemplate>
        <div class="delete-confirmation-popup-body-content">
            <p>Bu teminat mektubunu silmek istediğinize emin misiniz? Bu işlem geri alınamaz.</p>
        </div>
    </BodyContentTemplate>
    <FooterContentTemplate>
        <div class="delete-confirmation-popup-footer-actions">
            <DxButton Text="Vazgeç"
                      RenderStyle="ButtonRenderStyle.Secondary"
                      Click="@(() => DeleteConfirmationVisible = false)" />
            <DxButton Text="Evet, Sil"
                      RenderStyle="ButtonRenderStyle.Danger"
                      Click="@ConfirmDelete" />
        </div>
    </FooterContentTemplate>
</DxPopup>


@code {
    [Parameter] public int Id { get; set; }
    private bool DeleteConfirmationVisible { get; set; }
    private GuaranteeModel? Model { get; set; }
    private bool IsSmallScreen { get; set; }
    private bool IsDataLoaded { get; set; }
    private int ActiveTabIndex { get; set; }
    private bool AddPopupVisible { get; set; }
    private int? SelectedCommissionId { get; set; }
    private GridDevExtremeDataSource<GuaranteeCommissionModel>? CommissionDataSource { get; set; }
    private GuaranteeCommissionAddComponent? addFormRef;

    bool IsReturnPopupVisible { get; set; } = false;
    DateTime? ReturnDate { get; set; } = DateTime.Now;
    protected override async Task OnInitializedAsync()
    {
        IsDataLoaded = false;
        await LoadDataAsync();
        IsDataLoaded = true;
    }

    private async Task LoadDataAsync()
    {
        try
        {
            var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
            var response = await client.GetAsync($"api/guarantees/{Id}");

            if (response.IsSuccessStatusCode)
            {
                Model = await response.Content.ReadFromJsonAsync<GuaranteeModel>();
                await LoadTabData(ActiveTabIndex);
            }
            else
            {
                NavigationManager.NavigateTo("/guarantee/list");
            }
        }
        catch
        {
            NavigationManager.NavigateTo("/guarantee/list");
        }
    }

    private async Task OnActiveTabIndexChanged(int index)
    {
        ActiveTabIndex = index;
        await LoadTabData(index);
    }

    private async Task LoadTabData(int index)
    {
        var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
        string baseUrl = "https://localhost:7071/api";

        if (index == 0)
        {
            CommissionDataSource =
                new GridDevExtremeDataSource<GuaranteeCommissionModel>(
                    client,
                    NavigationManager.ToAbsoluteUri($"{baseUrl}/guarantee-commissions?guaranteeId={Id}")
                );
        }

        await InvokeAsync(StateHasChanged);
    }

    private void GuaranteeCommissionAdd()
    {
        SelectedCommissionId = null;
        AddPopupVisible = true;
    }

    private async Task SaveCommissionFromPopup()
    {
        if (addFormRef != null)
            await addFormRef.SaveAsync();
    }

    private async Task CancelCommissionFromPopup()
    {
        if (addFormRef != null)
            await addFormRef.CancelAsync();
    }

    private async Task OnCommissionSaved()
    {
        AddPopupVisible = false;
        SelectedCommissionId = null;
        await LoadTabData(ActiveTabIndex);
    }

    private void OnCommissionCanceled()
    {
        AddPopupVisible = false;
        SelectedCommissionId = null;
    }

    private void OnCommissionEditStart(GridEditStartEventArgs e)
    {
        e.Cancel = true;
        var item = (GuaranteeCommissionModel)e.DataItem;
        SelectedCommissionId = item.Id;
        AddPopupVisible = true;
    }

    private async Task DeleteCommission(int commissionId)
    {
        var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
        var response = await client.DeleteAsync($"api/guarantee-commissions/{commissionId}");
        if (response.IsSuccessStatusCode)
            await LoadTabData(ActiveTabIndex);
    }
    private async Task OnEditClick()
    {
        NavigationManager.NavigateTo($"/guarantee/createorupdate/{Id}");
    }


    private void OnDeleteClick()
    {
        DeleteConfirmationVisible = true;
    }

    private async Task ConfirmDelete()
    {
        DeleteConfirmationVisible = false;
        IsDataLoaded = false;
        await InvokeAsync(StateHasChanged);

        try
        {
            var client = await ApiClientFactory.CreateAsync(
                HttpClientFactory.CreateClient("ApiClient")
            );

            var response = await client.DeleteAsync($"api/guarantees/{Id}");

            if (response.IsSuccessStatusCode)
            {
                NavigationManager.NavigateTo("/guarantee/list");
                return;
            }

            IsDataLoaded = true;

            if (response.StatusCode == System.Net.HttpStatusCode.Conflict)
            {
                var message = await response.Content.ReadAsStringAsync();
                ToastService.ShowToast(new ToastOptions()
                {
                    Id = "toast",
                    ProviderName = "Overview",
                    ThemeMode = ToastThemeMode.Light,
                    RenderStyle = ToastRenderStyle.Warning,
                    Title = "Silme Engellendi",
                    Text = string.IsNullOrWhiteSpace(message)
                        ? "Bu teminat aktif ihalelerde kullanıldığı için silinemez."
                        : message
                }, RenderToastButton(true));
            }
            else
            {
                ToastService.ShowToast(new ToastOptions()
                {
                    Id = "toast",
                    ProviderName = "Overview",
                    ThemeMode = ToastThemeMode.Light,
                    RenderStyle = ToastRenderStyle.Danger,
                    Title = "Silme Hatası",
                    Text = "Silme işlemi sırasında beklenmeyen bir hata oluştu."
                }, RenderToastButton(true));
            }
        }
        catch (Exception ex)
        {
            IsDataLoaded = true; 
            ToastService.ShowToast(new ToastOptions()
            {
                Id = "toast",
                ProviderName = "Overview",
                ThemeMode = ToastThemeMode.Light,
                RenderStyle = ToastRenderStyle.Warning,
                Title = "Hata",
                Text = ex.Message
            }, RenderToastButton(true));
        }
        finally
        {
            IsDataLoaded = true;
            await InvokeAsync(StateHasChanged);
        }
    }
    private RenderFragment RenderToastButton(bool isError)
    {
        return @<div class="d-flex gap-2">
            <DxButton Click="@(isError? OnPopupError:OnPopupOk)" RenderStyle="@(isError? ButtonRenderStyle.Danger: ButtonRenderStyle.Success)">Kapat</DxButton>
        </div>
    ;
    }
    private void OnPopupOk()
    {
        NavigationManager.NavigateTo("/guarantee/list");
    }

    private void OnPopupError()
    {
    }

    private string GetAuthorityInitials(string? authorityName)
    {
        if (string.IsNullOrWhiteSpace(authorityName))
            return "";


        var words = authorityName
        .Trim()
        .Split(' ', StringSplitOptions.RemoveEmptyEntries);


        if (words.Length == 1)
        {
            return words[0].Substring(0, 1).ToUpper();
        }


        return (
        words[0].Substring(0, 1) +
        words[1].Substring(0, 1)
        ).ToUpper();
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo("/guarantee/list");
    }
    private async Task ReturnClick()
    {
        ReturnDate = DateTime.Now; 
        IsReturnPopupVisible = true;
    }

    void OnCancelReturn() => IsReturnPopupVisible = false;

    async Task OnConfirmReturn()
    {
        if (ReturnDate == null) return;

        try
        {
            IsDataLoaded = false;
            IsReturnPopupVisible = false;
            await InvokeAsync(StateHasChanged);

            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            var client = await ApiClientFactory.CreateAsync(httpClient);

            var model = new
            {
                Id = Id,
                ReturnDate = ReturnDate.Value.ToString("yyyy-MM-dd")
            };

            var response = await client.PutAsJsonAsync($"https://localhost:7071/api/guarantees/return", model);

            if (response.IsSuccessStatusCode)
            {
                await LoadDataAsync();
                ToastService.ShowToast(new ToastOptions()
                {
                    Id = "toast",
                    ProviderName = "Overview",
                    ThemeMode = ToastThemeMode.Light,
                    RenderStyle = ToastRenderStyle.Success,
                    Title = "Başarılı",
                    Text = "İade işlemi gerçekleştirildi.",
                }, RenderToastButton(false));
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                ToastService.ShowToast(new ToastOptions()
                {
                    Id = "toast",
                    ProviderName = "Overview",
                    ThemeMode = ToastThemeMode.Light,
                    RenderStyle = ToastRenderStyle.Danger,
                    Title = "Hata",
                    Text = errorMsg
                }, RenderToastButton(true));
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast(new ToastOptions()
            {
                Id = "toast",
                ProviderName = "Overview",
                ThemeMode = ToastThemeMode.Light,
                RenderStyle = ToastRenderStyle.Danger,
                Title = "Hata",
                Text = ex.Message
            }, RenderToastButton(true));
        }
        finally
        {
            IsDataLoaded = true;
            await InvokeAsync(StateHasChanged);
        }
    }
}