@page "/guarantee/details/{Id:int}"
@using System.Net.Http.Json
@inject NavigationManager NavigationManager
@inject IApiClientFactory ApiClientFactory
@inject IHttpClientFactory HttpClientFactory

<DxLayoutBreakpoint DeviceSize="DeviceSize.XSmall | DeviceSize.Small | DeviceSize.Medium"
                    @bind-IsActive="@IsSmallScreen" />

<div class="content-root">
    <div class="card toolbar">
        <DxToolbar ItemRenderStyleMode="ToolbarRenderStyleMode.Plain">
            <DxToolbarItem IconCssClass="back-icon icon medium-icon"
                           Tooltip="Geri"
                           Click="@NavigateBack" />

            <DxToolbarItem>
                <Template>
                    <div class="custom-item">
                        <div class="title">Teminat Mektubu Detayı</div>
                    </div>
                </Template>
            </DxToolbarItem>

            <DxToolbarItem Alignment="ToolbarItemAlignment.Right"
                           Click="@LoadDataAsync"
                           Tooltip="Yenile"
                           IconCssClass="refresh-icon icon medium-icon" />
        </DxToolbar>
    </div>

    <div class="guarantee-details">
        <DxLoadingPanel Visible="@(!IsDataLoaded)"
                        IsContentBlocked="true"
                        IsContentVisible="false"
                        IndicatorVisible="true"
                        IndicatorAreaVisible="true"
                        ZIndex="101"
                        Text="Yükleniyor...">

            <DxGridLayout ColumnSpacing="1rem"
                          RowSpacing="1rem"
                          CssClass="h-100">

                <Columns>
                    @if (!IsSmallScreen)
                    {
                        <DxGridLayoutColumn Width="1fr" />
                        <DxGridLayoutColumn Width="3fr" />
                    }
                    else
                    {
                        <DxGridLayoutColumn Width="100%" />
                    }
                </Columns>

                <Rows>
                    @if (!IsSmallScreen)
                    {
                        <DxGridLayoutRow Areas="item1 item2" />
                    }
                    else
                    {
                        <DxGridLayoutRow Areas="item1" />
                        <DxGridLayoutRow Areas="item2" />
                    }
                </Rows>

                <Items>
                    <DxGridLayoutItem Area="item1">
                        <Template>
                            @if (Model != null)
                            {
                                <div class="card h-100">
                                    <div class="authority-header">
                                        <div class="authority-avatar">
                                            @(!string.IsNullOrEmpty(Model.BankName)
                                                                                    ? Model.BankName[0].ToString().ToUpper()
                                                                                    : "?")
                                        </div>

                                        <h5 class="authority-title">
                                            @Model.BankName
                                        </h5>

                                        <span class="authority-badge">
                                            Teminat No: #@Model.GuaranteeNumber
                                        </span>
                                    </div>

                                    <div class="guarantee-stats">
                                        <div class="guarantee-stat">
                                            <i class="ti ti-gavel guarantee-icon-primary"></i>
                                            <div class="guarantee-stat-title">@Model.GuaranteeType</div>
                                            <small>Teminat Türü</small>
                                        </div>

                                        <div class="guarantee-stat">
                                            <i class="ti ti-currency-dollar guarantee-icon-success"></i>
                                            <div class="guarantee-stat-title">
                                                @Model.GuaranteeAmount.ToString("n2")
                                            </div>
                                            <small>@Model.Currency</small>
                                        </div>
                                    </div>

                                    <h6 class="guarantee-section-title">
                                        GENEL BİLGİLER
                                    </h6>

                                    <div class="guarantee-info">
                                        <div class="guarantee-info-row">
                                            <span>Başlangıç:</span>
                                            <span>@Model.GuaranteeDate.ToShortDateString()</span>
                                        </div>
                                        <div class="guarantee-info-row">
                                            <span>Bitiş:</span>
                                            <span>@Model.ExpiryDate.ToShortDateString()</span>
                                        </div>
                                        <div class="guarantee-info-row">
                                            <span>Komisyon:</span>
                                            <span>@Model.CommissionAmount.ToString("n2") @Model.Currency</span>
                                        </div>
                                        <div class="guarantee-info-row">
                                            <span>Oran:</span>
                                            <span>@Model.CommissionRate.ToString("n4")</span>
                                        </div>
                                        <div class="guarantee-info-row">
                                            <span>Banka:</span>
                                            <span>@Model.BankBranchName</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </Template>
                    </DxGridLayoutItem>

                    <DxGridLayoutItem Area="item2">
                        <Template>
                            <DxTabs CssClass="card tabs"
                                    ActiveTabIndex="@ActiveTabIndex"
                                    ActiveTabIndexChanged="OnActiveTabIndexChanged">

                                <DxTabPage Text="Komisyonlar">
                                    <div class="grid-header-actions mb-3">
                                        <DxButton Text="Yeni Komisyon Ekle"
                                                  RenderStyle="ButtonRenderStyle.Primary"
                                                  IconCssClass="ti ti-plus"
                                                  Click="@(() => NavigationManager.NavigateTo($"/guarantee-commission/add/{Id}"))" />
                                    </div>

                                    <DxGrid Data="CommissionDataSource"
                                            ShowFilterRow="true"
                                            ShowGroupPanel="true"
                                            ColumnResizeMode="GridColumnResizeMode.ColumnsContainer"
                                            EditStart="OnCommissionEditStart"
                                            DataItemDeleting="async (e) => await DeleteCommission(((GuaranteeCommissionModel)e.DataItem).Id)">
                                        <ToolbarTemplate>
                                            <DxToolbar ItemRenderStyleMode="ToolbarRenderStyleMode.Plain">
                                                <DxToolbarItem Text="New" Click="GuaranteeCommissionAdd" IconCssClass="grid-toolbar-new" />
                                                
                                            </DxToolbar>
                                        </ToolbarTemplate>
                                        <Columns>
                                            <DxGridDataColumn FieldName="@nameof(GuaranteeCommissionModel.CommissionStartDate)" Caption="Başlangıç" />
                                            <DxGridDataColumn FieldName="@nameof(GuaranteeCommissionModel.CommissionEndDate)" Caption="Bitiş" />
                                            <DxGridDataColumn FieldName="@nameof(GuaranteeCommissionModel.CommissionAmount)" Caption="Tutar" DisplayFormat="N2" />
                                            <DxGridDataColumn FieldName="@nameof(GuaranteeCommissionModel.Currency)" Caption="Döviz" />
                                            <DxGridDataColumn FieldName="@nameof(GuaranteeCommissionModel.PaymentStatus)" Caption="Durum" />
                                            <DxGridDataColumn FieldName="@nameof(GuaranteeCommissionModel.Note)" Caption="Açıklama" />

                                            <DxGridCommandColumn Width="120px"
                                                                 EditButtonVisible="true"
                                                                 DeleteButtonVisible="true"
                                                                 NewButtonVisible="false" />
                                        </Columns>
                                    </DxGrid>
                                </DxTabPage>

                            </DxTabs>
                        </Template>
                    </DxGridLayoutItem>
                </Items>
            </DxGridLayout>
        </DxLoadingPanel>
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }

    private GuaranteeModel? Model { get; set; }
    private bool IsSmallScreen { get; set; }
    private bool IsDataLoaded { get; set; }
    private int ActiveTabIndex { get; set; }
    private GridDevExtremeDataSource<GuaranteeCommissionModel>? CommissionDataSource { get; set; }

    protected override async Task OnInitializedAsync()
    {
        IsDataLoaded = false;
        await LoadDataAsync();
        IsDataLoaded = true;
    }

    private async Task LoadDataAsync()
    {
        try
        {
            var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
            var response = await client.GetAsync($"api/guarantees/{Id}");

            if (response.IsSuccessStatusCode)
            {
                Model = await response.Content.ReadFromJsonAsync<GuaranteeModel>();
                await LoadTabData(ActiveTabIndex);
            }
            else
            {
                NavigationManager.NavigateTo("/guarantee/list");
            }
        }
        catch
        {
            NavigationManager.NavigateTo("/guarantee/list");
        }
    }

    private async Task OnActiveTabIndexChanged(int index)
    {
        ActiveTabIndex = index;
        await LoadTabData(index);
    }

    private async Task LoadTabData(int index)
    {
        var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
        string baseUrl = "https://localhost:7071/api";

        if (index == 0)
        {
            CommissionDataSource =
                new GridDevExtremeDataSource<GuaranteeCommissionModel>(
                    client,
                    NavigationManager.ToAbsoluteUri($"{baseUrl}/guarantee-commissions?guaranteeId={Id}")
                );
        }

        await InvokeAsync(StateHasChanged);
    }

    private void OnCommissionEditStart(GridEditStartEventArgs e)
    {
        e.Cancel = true;
        var item = (GuaranteeCommissionModel)e.DataItem;
        NavigationManager.NavigateTo($"/guarantee-commission/edit/{item.Id}");
    }

    private async Task DeleteCommission(int commissionId)
    {
        var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
        var response = await client.DeleteAsync($"api/guarantee-commissions/{commissionId}");
        if (response.IsSuccessStatusCode)
        {
            await LoadTabData(ActiveTabIndex);
        }
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo("/guarantee/list");
    }

    private void GuaranteeCommissionAdd()
    {
  
    }
}
