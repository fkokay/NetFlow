@inject IApiClientFactory ApiClientFactory
@inject IHttpClientFactory HttpClientFactory
@using System.Net.Http.Json

@if (editContext == null)
{
    <div class="d-flex justify-content-center p-5">
        <DxWaitIndicator Visible="true" />
        <span class="ms-2">Yükleniyor...</span>
    </div>
}
else
{

    <EditForm EditContext="@editContext" Context="editFormContext">
        <DataAnnotationsValidator />

        @if (isLoading)
        {
            <div class="d-flex justify-content-center p-4">
                <DxWaitIndicator Visible="true" />
                <span class="ms-2">Veriler güncelleniyor...</span>
            </div>
        }
        else
        {
            <DxFormLayout>
                <DxFormLayoutItem Caption="Baþlangýç Tarihi" ColSpanMd="12">
                    <DxDateEdit @bind-Date="model.CommissionStartDate"
                                ValidationEnabled="true"
                                ShowValidationIcon="true" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Bitiþ Tarihi" ColSpanMd="12">
                    <DxDateEdit @bind-Date="model.CommissionEndDate"
                                ValidationEnabled="true"
                                ShowValidationIcon="true" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Komisyon Oraný (%)" ColSpanMd="12">
                    <DxSpinEdit @bind-Value="model.CommissionRate"
                                DisplayFormat="N4"
                                ShowValidationIcon="true" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Komisyon Tutarý" ColSpanMd="12">
                    <DxSpinEdit @bind-Value="model.CommissionAmount"
                                DisplayFormat="N2"
                                ShowValidationIcon="true" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Para Birimi" ColSpanMd="12">
                    <DxTextBox @bind-Text="model.Currency" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Banka Ref. No" ColSpanMd="12">
                    <DxTextBox @bind-Text="model.BankReferenceNo" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Not / Açýklama" ColSpanMd="12">
                    <DxMemo @bind-Text="model.Note" Rows="3" />
                </DxFormLayoutItem>

                <DxFormLayoutItem ColSpanMd="12">
                    <ValidationSummary />
                </DxFormLayoutItem>
            </DxFormLayout>
        }
    </EditForm>
}

@code {
    [Parameter] public int GuaranteeId { get; set; }
    [Parameter] public int? CommissionId { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private GuaranteeCommissionModel model = new();
    private EditContext? editContext; 
    private bool isSaving;
    private bool isLoading;

    protected override async Task OnParametersSetAsync()
    {
        if (CommissionId.HasValue && CommissionId.Value > 0)
        {
            await LoadModelAsync(CommissionId.Value);
        }
        else
        {
            model = new()
            {
                GuaranteeId = GuaranteeId,
                CommissionStartDate = DateTime.Now,
                CommissionEndDate = DateTime.Now.AddMonths(3)
            };
            editContext = new EditContext(model);
        }
    }

    private async Task LoadModelAsync(int id)
    {
        isLoading = true;
        editContext = null;
        StateHasChanged();

        try
        {
            var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
            var result = await client.GetFromJsonAsync<GuaranteeCommissionModel>($"api/guarantee-commissions/{id}");
            if (result != null)
            {
                model = result;
                editContext = new EditContext(model);
            }
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    public async Task SaveAsync()
    {
        if (isSaving || isLoading || editContext == null) return;
        if (!editContext.Validate()) return;

        isSaving = true;
        try
        {
            var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
            HttpResponseMessage response;

            if (model.Id > 0)
                response = await client.PutAsJsonAsync("api/guarantee-commissions", model);
            else
                response = await client.PostAsJsonAsync("api/guarantee-commissions", model);

            if (response.IsSuccessStatusCode)
                await OnSaved.InvokeAsync();
        }
        finally
        {
            isSaving = false;
        }
    }

    public async Task CancelAsync() => await OnCancel.InvokeAsync();
}