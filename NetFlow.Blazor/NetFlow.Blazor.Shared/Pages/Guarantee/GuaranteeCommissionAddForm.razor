@inject IApiClientFactory ApiClientFactory
@inject IHttpClientFactory HttpClientFactory

<EditForm EditContext="@editContext" Context="editFormContext">
    <DataAnnotationsValidator />

    <DxFormLayout>

        <DxFormLayoutItem Caption="Baþlangýç Tarihi" ColSpanMd="12">
            <DxDateEdit @bind-Date="model.CommissionStartDate"
                        ValidationEnabled="true"
                        ShowValidationIcon="true" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Bitiþ Tarihi" ColSpanMd="12">
            <DxDateEdit @bind-Date="model.CommissionEndDate"
                        ValidationEnabled="true"
                        ShowValidationIcon="true" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Komisyon Oraný (%)" ColSpanMd="12">
            <DxSpinEdit @bind-Value="model.CommissionRate"
                        DisplayFormat="N4"
                        ShowValidationIcon="true" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Komisyon Tutarý" ColSpanMd="12">
            <DxSpinEdit @bind-Value="model.CommissionAmount"
                        DisplayFormat="N2"
                        ShowValidationIcon="true" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Para Birimi" ColSpanMd="12">
            <DxTextBox @bind-Text="model.Currency" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Ödeme Durumu" ColSpanMd="12">
            <DxComboBox Data="@(new List<string> { "Beklemede", "Ödendi", "Ýptal" })"
                        @bind-Value="model.PaymentStatus" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Ödeme Tarihi" ColSpanMd="12">
            <DxDateEdit @bind-Date="model.PaymentDate"
                        ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Banka Ref. No" ColSpanMd="12">
            <DxTextBox @bind-Text="model.BankReferenceNo" />
        </DxFormLayoutItem>

        <DxFormLayoutItem Caption="Not / Açýklama" ColSpanMd="12">
            <DxMemo @bind-Text="model.Note" Rows="3" />
        </DxFormLayoutItem>

        <DxFormLayoutItem ColSpanMd="12">
            <ValidationSummary />
        </DxFormLayoutItem>


    </DxFormLayout>
</EditForm>
@code {
    [Parameter] public int GuaranteeId { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private GuaranteeCommissionModel model = new();
    private EditContext editContext = default!;
    private bool isSaving;

    protected override void OnInitialized()
    {
        model.GuaranteeId = GuaranteeId;
        model.CommissionStartDate = DateTime.Now;
        model.CommissionEndDate = DateTime.Now.AddMonths(3);
        editContext = new EditContext(model);
    }

    public async Task SaveAsync()
    {
        if (isSaving) return;
        if (!editContext.Validate()) return;

        isSaving = true;

        try
        {
            var client = await ApiClientFactory.CreateAsync(
                HttpClientFactory.CreateClient("ApiClient"));

            var response = await client.PostAsJsonAsync("api/guarantee-commissions", model);

            if (response.IsSuccessStatusCode)
            {
                await OnSaved.InvokeAsync();
            }
        }
        finally
        {
            isSaving = false;
        }
    }

    public async Task CancelAsync()
    {
        await OnCancel.InvokeAsync();
    }
}
