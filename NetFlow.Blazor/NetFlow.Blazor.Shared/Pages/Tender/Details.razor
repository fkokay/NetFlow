@page "/tender/details/{Id:int}"
@using System.Net.Http.Json
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IApiClientFactory ApiClientFactory
@inject IHttpClientFactory HttpClientFactory


<div class="tender-detail-wrapper">
    @if (Model == null)
    {
        <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 400px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
            <DxLoadingPanel Visible="true"
                            Text="Ýhale detaylarý yükleniyor..."
                            IsContentBlocked="true" />
        </div>
    }
    else
    {
        <div class="tender-header">
            <div>
                <h4 class="tender-title">
                    <span>Ýhale Detayý /</span> #@Model.TenderCode
                </h4>
            </div>

            <DxButton Text="Listeye Dön"
                      RenderStyle="ButtonRenderStyle.Secondary"
                      IconCssClass="ti ti-arrow-left"
                      Click="@(() => NavigationManager.NavigateTo("/tender/list"))" />
        </div>

        <DxFormLayout>
            <DxFormLayoutItem ColSpanMd="12">
                <Template>
                    <div class="tender-row">

                        <!-- SOL PANEL -->
                        <div class="tender-left">
                            <div class="tender-card tender-card-padding">

                                <div class="authority-header">
                                    <div class="authority-avatar">
                                        @(!string.IsNullOrEmpty(Model.PublicAuthorityName)
                                                                            ? Model.PublicAuthorityName[0].ToString().ToUpper()
                                                                            : "?")
                                    </div>

                                    <h5 class="authority-title">
                                        @Model.PublicAuthorityName
                                    </h5>

                                    <span class="authority-badge">
                                        Müþteri No: #@Model.PublicAuthorityCode
                                    </span>
                                </div>

                                <div class="tender-stats">
                                    <div class="tender-stat">
                                        <i class="ti ti-gavel tender-icon-primary"></i>
                                        <div class="tender-stat-title">@Model.TenderCode</div>
                                        <small>Ýhale No</small>
                                    </div>

                                    <div class="tender-stat">
                                        <i class="ti ti-currency-dollar tender-icon-success"></i>
                                        <div class="tender-stat-title">
                                            @Model.TenderAmount.ToString("n2")
                                        </div>
                                        <small>@Model.Currency</small>
                                    </div>
                                </div>

                                <h6 class="tender-section-title">
                                    GENEL BÝLGÝLER
                                </h6>

                                <div class="tender-info">
                                    <div class="tender-info-row">
                                        <span>Ýhale:</span>
                                        <span class="tender-info-strong">@Model.TenderName</span>
                                    </div>
                                    <div class="tender-info-row">
                                        <span>Baþlangýç:</span>
                                        <span>@Model.TenderStartDate.ToShortDateString()</span>
                                    </div>
                                    <div class="tender-info-row">
                                        <span>Bitiþ:</span>
                                        <span>@Model.TenderEndDate.ToShortDateString()</span>
                                    </div>
                                    <div class="tender-info-row">
                                        <span>Tür:</span>
                                        <span>@Model.TenderType</span>
                                    </div>
                                    <div class="tender-info-row">
                                        <span>Metot:</span>
                                        <span>@Model.TenderMethod</span>
                                    </div>
                                    <div class="tender-info-row">
                                        <span>Sözleþme:</span>
                                        <span>@(Model.ContractDate?.ToShortDateString() ?? "-")</span>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- SAÐ PANEL -->
                        <div class="tender-right">
                            <div class="tender-card tender-card-tabs">

                                <DxTabs ActiveTabIndex="@ActiveTabIndex"
                                        ActiveTabIndexChanged="OnActiveTabIndexChanged"
                                        class="tender-tabs">
                                    <DxTabPage Text="Cihazlar" />
                                    <DxTabPage Text="Opex" />
                                    <DxTabPage Text="Capex" />
                                    <DxTabPage Text="Reaktif" />
                                    <DxTabPage Text="Belgeler" />
                                </DxTabs>

                                <div class="tender-content">

                                    @switch (ActiveTabIndex)
                                    {
                                        case 0:
                                            <DxGrid Data="DeviceDataSource" ShowSearchBox="true" Height="500px">
                                                <Columns>
                                                    <DxGridDataColumn FieldName="SupplyType" Caption="Tedarik Türü" />
                                                    <DxGridDataColumn FieldName="StockCode" Caption="Stok Kodu" />
                                                    <DxGridDataColumn FieldName="Quantity" Caption="Miktar" />
                                                    <DxGridDataColumn FieldName="CustomerCode" Caption="Müþteri Kodu" />
                                                    <DxGridDataColumn FieldName="CustomerName" Caption="Müþteri Ünvaný" />
                                                    <DxGridDataColumn FieldName="RentUnitPrice" Caption="Kira" DisplayFormat="n2" />
                                                    <DxGridDataColumn FieldName="ServiceUnitPrice" Caption="Servis" DisplayFormat="n2" />
                                                    <DxGridDataColumn FieldName="LinkUnitPrice" Caption="Link" DisplayFormat="n2" />
                                                    <DxGridDataColumn FieldName="PurchasePrice" Caption="Satýnalma" DisplayFormat="n2" />
                                                    <DxGridDataColumn FieldName="Currency" Caption="Para Birimi" />
                                                </Columns>
                                            </DxGrid>
                                            break;

                                        case 1:
                                            <DxGrid Data="OpexDataSource" ShowSearchBox="true" Height="500px">
                                                <Columns>
                                                    <DxGridDataColumn FieldName="UnitName" Caption="Alt Kurum Adý" />
                                                    <DxGridDataColumn FieldName="StockCode" Caption="Stok Kodu" />
                                                    <DxGridDataColumn FieldName="Quantity" Caption="Miktar" />
                                                    <DxGridDataColumn FieldName="UnitPrice" Caption="Fiyat" DisplayFormat="n2" />
                                                    <DxGridDataColumn FieldName="Currency" Caption="Para Birimi" />
                                                </Columns>
                                            </DxGrid>
                                            break;

                                        case 2:
                                            <DxGrid Data="CapexDataSource" ShowSearchBox="true" Height="500px">
                                                <Columns>
                                                    <DxGridDataColumn FieldName="UnitCode" Caption="Alt Kurum Kodu" />
                                                    <DxGridDataColumn FieldName="UnitName" Caption="Alt Kurum Adý" />
                                                    <DxGridDataColumn FieldName="AssetCode" Caption="Demirbaþ Kodu" />
                                                    <DxGridDataColumn FieldName="Quantity" Caption="Miktar" />
                                                    <DxGridDataColumn FieldName="Unit" Caption="Birim" />
                                                </Columns>
                                            </DxGrid>
                                            break;

                                        case 3:
                                            <DxGrid Data="ReaktifDataSource" ShowSearchBox="true" Height="500px">
                                                <Columns>
                                                    <DxGridDataColumn FieldName="UnitCode" Caption="Alt Kurum Kodu" />
                                                    <DxGridDataColumn FieldName="UnitName" Caption="Alt Kurum Adý" />
                                                    <DxGridDataColumn FieldName="StockCode" Caption="Stok Kodu" />
                                                    <DxGridDataColumn FieldName="SutCode" Caption="SUT Kodu" />
                                                    <DxGridDataColumn FieldName="TestName" Caption="Test Adý" />
                                                    <DxGridDataColumn FieldName="TestCount" Caption="Test Sayýsý" />
                                                    <DxGridDataColumn FieldName="UnitPrice" Caption="Birim Fiyat" DisplayFormat="n2" />
                                                    <DxGridDataColumn FieldName="Currency" Caption="Para Birimi" />
                                                </Columns>
                                            </DxGrid>
                                            break;

                                        case 4:
                                            <DxGrid Data="RequiredDocumentDataSource" Height="500px">
                                                <Columns>
                                                    <DxGridDataColumn FieldName="DocumentName" Caption="Belge" />

                                                    <DxGridDataColumn FieldName="IsMandatory" Caption="Zorunlu" Width="100px"
                                                                      TextAlignment="GridTextAlignment.Center">
                                                        <CellDisplayTemplate Context="ctx">
                                                            @{
                                                                var doc = (TenderRequiredDocument)ctx.DataItem;
                                                                <DxCheckBox Checked="@doc.IsMandatory" Enabled="false" />
                                                            }
                                                        </CellDisplayTemplate>
                                                    </DxGridDataColumn>

                                                    <DxGridDataColumn FieldName="Submitted" Caption="Durum" Width="100px"
                                                                      TextAlignment="GridTextAlignment.Center">
                                                        <CellDisplayTemplate Context="ctx">
                                                            @{
                                                                var doc = (TenderRequiredDocument)ctx.DataItem;
                                                                <DxCheckBox Checked="@doc.Submitted" Enabled="false" />
                                                            }
                                                        </CellDisplayTemplate>
                                                    </DxGridDataColumn>

                                                    <DxGridDataColumn FieldName="SubmissionDate" Caption="Yüklenme Tarihi"
                                                                      TextAlignment="GridTextAlignment.Center">
                                                        <CellDisplayTemplate Context="ctx">
                                                            @{
                                                                var doc = (TenderRequiredDocument)ctx.DataItem;
                                                                <span>
                                                                    @(doc.SubmissionDate.HasValue ? doc.SubmissionDate.Value.ToString("dd.MM.yyyy")
                                                                                                                        : "-")
                                                                </span>
                                                            }
                                                        </CellDisplayTemplate>
                                                    </DxGridDataColumn>

                                                    <DxGridDataColumn Caption="Ýncele" Width="100px"
                                                                      TextAlignment="GridTextAlignment.Center">
                                                        <CellDisplayTemplate Context="ctx">
                                                            @{
                                                                var doc = (TenderRequiredDocument)ctx.DataItem;
                                                                if (doc.TenderRequiredDocumentFileId.HasValue)
                                                                {
                                                                    <DxButton RenderStyle="ButtonRenderStyle.Primary"
                                                                              RenderStyleMode="ButtonRenderStyleMode.Outline"
                                                                              SizeMode="SizeMode.Small"
                                                                              Click="@(() => HandleFileAction(doc))"
                                                                              IconCssClass="ti ti-file-text" />
                                                                }
                                                                else
                                                                {
                                                                    <span class="text-muted">-</span>
                                                                }
                                                            }
                                                        </CellDisplayTemplate>
                                                    </DxGridDataColumn>
                                                </Columns>
                                            </DxGrid>
                                            break;
                                    }

                                </div>
                            </div>
                        </div>

                    </div>
                </Template>
            </DxFormLayoutItem>

        </DxFormLayout>
    }
</div>

<DxWindow Visible="@PdfModalVisible" VisibleChanged="@((value) => PdfModalVisible = value)" HeaderText="Belge Görüntüleme" Width="90vw" Height="85vh" AllowResize="true" ShowCloseButton="true" CloseOnEscape="true" HeaderCssClass="font-weight-bold">
    <BodyTemplate>
        <iframe src="@PdfDataUrl" style="width:100%; height:100%; border:none;"></iframe>
    </BodyTemplate>
</DxWindow>

<script>
    window.downloadFileFromBase64 = (fileName, base64String, contentType) => {
        const link = document.createElement('a');
        link.download = fileName;
        link.href = `data:${contentType};base64,${base64String}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
</script>

@code {
    [Parameter] public int Id { get; set; }
    private TenderModel? Model { get; set; }
    private int ActiveTabIndex { get; set; } = 0;
    private bool PdfModalVisible { get; set; }
    private string PdfDataUrl { get; set; } = "";

    private GridDevExtremeDataSource<TenderDeviceModel>? DeviceDataSource { get; set; }
    private GridDevExtremeDataSource<TenderOpexModel>? OpexDataSource { get; set; }
    private GridDevExtremeDataSource<TenderCapexModel>? CapexDataSource { get; set; }
    private GridDevExtremeDataSource<TenderReaktifModel>? ReaktifDataSource { get; set; }
    private GridDevExtremeDataSource<TenderRequiredDocument>? RequiredDocumentDataSource { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadMainModel();
    }

    private async Task LoadMainModel()
    {
        try
        {
            var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
            var response = await client.GetAsync($"api/tenders/{Id}");

            if (response.IsSuccessStatusCode)
            {
                Model = await response.Content.ReadFromJsonAsync<TenderModel>();
                await LoadTabData(ActiveTabIndex);
            }
            else
            {
                NavigationManager.NavigateTo("/tender/list");
            }
        }
        catch
        {
            NavigationManager.NavigateTo("/tender/list");
        }
    }

    private async Task OnActiveTabIndexChanged(int index)
    {
        ActiveTabIndex = index;
        await LoadTabData(index);
    }

    private async Task LoadTabData(int index)
    {
        var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
        string baseUrl = "https://localhost:7071/api";

        switch (index)
        {
            case 0:
                DeviceDataSource = new GridDevExtremeDataSource<TenderDeviceModel>(client, NavigationManager.ToAbsoluteUri($"{baseUrl}/tender-devices?tenderId={Id}"));
                break;
            case 1:
                OpexDataSource = new GridDevExtremeDataSource<TenderOpexModel>(client, NavigationManager.ToAbsoluteUri($"{baseUrl}/tender-opex?tenderId={Id}"));
                break;
            case 2:
                CapexDataSource = new GridDevExtremeDataSource<TenderCapexModel>(client, NavigationManager.ToAbsoluteUri($"{baseUrl}/tender-capex?tenderId={Id}"));
                break;
            case 3:
                ReaktifDataSource = new GridDevExtremeDataSource<TenderReaktifModel>(client, NavigationManager.ToAbsoluteUri($"{baseUrl}/tender-reaktif?tenderId={Id}"));
                break;
            case 4:
                RequiredDocumentDataSource = new GridDevExtremeDataSource<TenderRequiredDocument>(client, NavigationManager.ToAbsoluteUri($"{baseUrl}/tender-documents?tenderId={Id}"));
                break;
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleFileAction(TenderRequiredDocument doc)
    {
        try
        {
       
            if (doc.FileContent == null) return;

            string base64String = Convert.ToBase64String(doc.FileContent);

            if (doc.FileType == "application/pdf")
            {
                PdfDataUrl = $"data:application/pdf;base64,{base64String}";
                PdfModalVisible = true;
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("downloadFileFromBase64", doc.FileName, base64String, doc.FileType);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }
}