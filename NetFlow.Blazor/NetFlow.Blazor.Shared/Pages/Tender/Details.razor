@page "/tender/details/{Id:int}"
@using System.Net.Http.Json
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IApiClientFactory ApiClientFactory
@inject IHttpClientFactory HttpClientFactory

<DxLayoutBreakpoint DeviceSize="DeviceSize.XSmall | DeviceSize.Small | DeviceSize.Medium" @bind-IsActive="@IsSmallScreen" />

<div class="content-root">
    <div class="card toolbar">
        <DxToolbar ItemRenderStyleMode="ToolbarRenderStyleMode.Plain">
            <DxToolbarItem IconCssClass="back-icon icon medium-icon" Tooltip="Go to Back" Click="@NavigateBack" />
            <DxToolbarItem>
                <Template>
                    <div class="custom-item">
                        <div class="title">İhale Detayı</div>
                    </div>
                </Template>
            </DxToolbarItem>
            <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                <Template>
                    <DxButton Text="Düzenle" Click="@OnEditClick" RenderStyleMode="ButtonRenderStyleMode.Outline" RenderStyle="ButtonRenderStyle.Danger" />
                </Template>
            </DxToolbarItem>
            <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                <Template>
                    <DxButton Text="Sil" Click="@OnDeleteClick" RenderStyleMode="ButtonRenderStyleMode.Outline" RenderStyle="ButtonRenderStyle.Danger" />
                </Template>
            </DxToolbarItem>
            <DxToolbarItem Alignment="ToolbarItemAlignment.Right" Click="@LoadDataAsync" Tooltip="Yenile" IconCssClass="refresh-icon icon medium-icon" />
        </DxToolbar>
    </div>

    <div class="tender-details">
        <DxLoadingPanel Visible="@(!IsDataLoaded)" IsContentBlocked="true" IsContentVisible="false" IndicatorVisible="true" IndicatorAreaVisible="true" ZIndex="101" Text="Yükleniyor...">
            <DxGridLayout ColumnSpacing="1rem" RowSpacing="1rem" CssClass="h-100" ">
                <Columns>
                    @if (!IsSmallScreen)
                    {
                        <DxGridLayoutColumn Width="1fr" />
                        <DxGridLayoutColumn Width="3fr" />
                    }
                    else
                    {
                        <DxGridLayoutColumn Width="100%" />
                    }
                </Columns>
                <Rows>
                    @if (!IsSmallScreen)
                    {
                        <DxGridLayoutRow Areas="item1 item2" />
                    }
                    else
                    {
                        <DxGridLayoutRow Areas="item1" />
                        <DxGridLayoutRow Areas="item2" />
                    }
                </Rows>
                <Items>
                    <DxGridLayoutItem Area="item1">
                        <Template>
                            @if (Model != null)
                            {
                                <div class="card h-100">
                                    <div class="authority-header">
                                        <div class="authority-avatar">
                                            @(!string.IsNullOrEmpty(Model.PublicAuthorityName)
                                                                                    ? Model.PublicAuthorityName[0].ToString().ToUpper()
                                                                                    : "?")
                                        </div>

                                        <h5 class="authority-title">
                                            @Model.PublicAuthorityName
                                        </h5>

                                        <span class="authority-badge">
                                            Müşteri No: #@Model.PublicAuthorityCode
                                        </span>
                                    </div>

                                    <div class="tender-stats">
                                        <div class="tender-stat">
                                            <i class="ti ti-gavel tender-icon-primary"></i>
                                            <div class="tender-stat-title">@Model.TenderCode</div>
                                            <small>İhale No</small>
                                        </div>

                                        <div class="tender-stat">
                                            <i class="ti ti-currency-dollar tender-icon-success"></i>
                                            <div class="tender-stat-title">
                                                @Model.TenderAmount.ToString("n2")
                                            </div>
                                            <small>@Model.Currency</small>
                                        </div>
                                    </div>

                                    <h6 class="tender-section-title">
                                        GENEL BİLGİLER
                                    </h6>

                                    <div class="tender-info">
                                        <div class="tender-info-row">
                                            <span>İhale:</span>
                                            <span class="tender-info-strong">@Model.TenderName</span>
                                        </div>
                                        <div class="tender-info-row">
                                            <span>Başlangıç:</span>
                                            <span>@Model.TenderStartDate.ToShortDateString()</span>
                                        </div>
                                        <div class="tender-info-row">
                                            <span>Bitiş:</span>
                                            <span>@Model.TenderEndDate.ToShortDateString()</span>
                                        </div>
                                        <div class="tender-info-row">
                                            <span>Tür:</span>
                                            <span>@Model.TenderType</span>
                                        </div>
                                        <div class="tender-info-row">
                                            <span>Metot:</span>
                                            <span>@Model.TenderMethod</span>
                                        </div>
                                        <div class="tender-info-row">
                                            <span>Sözleşme:</span>
                                            <span>@(Model.ContractDate?.ToShortDateString() ?? "-")</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </Template>
                    </DxGridLayoutItem>
                    <DxGridLayoutItem Area="item2">
                        <Template>
                            <DxTabs CssClass="card tabs">
                                <DxTabPage Text="Cihazlar" CssClass="tab-page">
                                    <TenderDevice TenderId="Id" />
                                </DxTabPage>
                                <DxTabPage Text="Opex" CssClass="tab-page">
                                    <DxGrid Data="OpexDataSource" ShowSearchBox="true" SearchBoxNullText="Arama yapmak için metin girin…" style="height:100%;">
                                        <Columns>
                                            <DxGridDataColumn FieldName="UnitCode" Caption="Alt Kurum Kodu" />
                                            <DxGridDataColumn FieldName="UnitName" Caption="Alt Kurum Adı" />
                                            <DxGridDataColumn FieldName="StockCode" Caption="Stok Kodu" />
                                            <DxGridDataColumn FieldName="StockName" Caption="Stok Adı" />
                                            <DxGridDataColumn FieldName="Quantity" Caption="Miktar" DisplayFormat="n2" />
                                            <DxGridDataColumn FieldName="UnitPrice" Caption="Tahmini Maliyet Fiyatı" DisplayFormat="n4" />
                                            <DxGridDataColumn FieldName="Currency" Caption="Para Birimi" />
                                        </Columns>
                                    </DxGrid>
                                </DxTabPage>
                                <DxTabPage Text="Capex" CssClass="tab-page">
                                    <DxGrid Data="CapexDataSource" ShowSearchBox="true" SearchBoxNullText="Arama yapmak için metin girin…" style="height:100%;">
                                        <Columns>
                                            <DxGridDataColumn FieldName="UnitCode" Caption="Alt Kurum Kodu" />
                                            <DxGridDataColumn FieldName="UnitName" Caption="Alt Kurum Adı" />
                                            <DxGridDataColumn FieldName="AssetCode" Caption="Demirbaş Kodu" />
                                            <DxGridDataColumn FieldName="Quantity" Caption="Miktar" />
                                            <DxGridDataColumn FieldName="Unit" Caption="Birim" />
                                        </Columns>
                                    </DxGrid>
                                </DxTabPage>
                                <DxTabPage Text="Reaktif" CssClass="tab-page">
                                    <DxGrid Data="ReaktifDataSource" ShowSearchBox="true" SearchBoxNullText="Arama yapmak için metin girin…" style="height:100%;">
                                        <Columns>
                                            <DxGridDataColumn FieldName="UnitCode" Caption="Alt Kurum Kodu" />
                                            <DxGridDataColumn FieldName="UnitName" Caption="Alt Kurum Adı" />
                                            <DxGridDataColumn FieldName="StockCode" Caption="Stok Kodu" />
                                            <DxGridDataColumn FieldName="SutCode" Caption="SUT Kodu" />
                                            <DxGridDataColumn FieldName="TestName" Caption="Test Adı" />
                                            <DxGridDataColumn FieldName="TestCount" Caption="Test Sayısı" />
                                            <DxGridDataColumn FieldName="UnitPrice" Caption="Birim Fiyat" DisplayFormat="n2" />
                                            <DxGridDataColumn FieldName="Currency" Caption="Para Birimi" />
                                        </Columns>
                                    </DxGrid>
                                </DxTabPage>
                                <DxTabPage Text="Belgeler" CssClass="tab-page">
                                    <DxGrid Data="RequiredDocumentDataSource" style="height:100%;">
                                        <Columns>
                                            <DxGridDataColumn FieldName="DocumentName" Caption="Belge" />

                                            <DxGridDataColumn FieldName="IsMandatory" Caption="Zorunlu" Width="100px"
                                                              TextAlignment="GridTextAlignment.Center">
                                                <CellDisplayTemplate Context="ctx">
                                                    @{
                                                        var doc = (TenderRequiredDocument)ctx.DataItem;
                                                        <DxCheckBox Checked="@doc.IsMandatory" Enabled="false" />
                                                    }
                                                </CellDisplayTemplate>
                                            </DxGridDataColumn>

                                            <DxGridDataColumn FieldName="Submitted" Caption="Durum" Width="100px"
                                                              TextAlignment="GridTextAlignment.Center">
                                                <CellDisplayTemplate Context="ctx">
                                                    @{
                                                        var doc = (TenderRequiredDocument)ctx.DataItem;
                                                        <DxCheckBox Checked="@doc.Submitted" Enabled="false" />
                                                    }
                                                </CellDisplayTemplate>
                                            </DxGridDataColumn>

                                            <DxGridDataColumn FieldName="SubmissionDate" Caption="Yüklenme Tarihi"
                                                              TextAlignment="GridTextAlignment.Center">
                                                <CellDisplayTemplate Context="ctx">
                                                    @{
                                                        var doc = (TenderRequiredDocument)ctx.DataItem;
                                                        <span>
                                                            @(doc.SubmissionDate.HasValue ? doc.SubmissionDate.Value.ToString("dd.MM.yyyy")
                                                                                                                    : "-")
                                                        </span>
                                                    }
                                                </CellDisplayTemplate>
                                            </DxGridDataColumn>

                                            <DxGridDataColumn Caption="İncele" Width="100px"
                                                              TextAlignment="GridTextAlignment.Center">
                                                <CellDisplayTemplate Context="ctx">
                                                    @{
                                                        var doc3 = (TenderRequiredDocument)ctx.DataItem;
                                                        if (doc3.TenderRequiredDocumentFileId.HasValue)
                                                        {
                                                            <DxButton Text="Görüntüle" RenderStyle="ButtonRenderStyle.Primary" RenderStyleMode="ButtonRenderStyleMode.Outline" SizeMode="SizeMode.Small"
                                                                      Click="@(() => HandleFileAction(doc3))"
                                                                      IconCssClass="@(doc3.FileType == "application/pdf" ? "ti ti-file-text text-danger" : "ti ti-file-text text-primary")" />
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    }
                                                </CellDisplayTemplate>
                                            </DxGridDataColumn>
                                        </Columns>
                                    </DxGrid>
                                </DxTabPage>
                            </DxTabs>
                        </Template>
                    </DxGridLayoutItem>
                </Items>
            </DxGridLayout>
        </DxLoadingPanel>
    </div>
</div>

<DxPopup @bind-Visible="@EditPopupVisible"
    ShowFooter="true"
    HeaderText="İhale Düzenleme">
    <BodyContentTemplate>
        <TenderEditForm />
    </BodyContentTemplate>
    <FooterContentTemplate>
        <DxButton CssClass="popup-button my-1 ms-2" RenderStyle="ButtonRenderStyle.Primary" Text="OK" Click="@(() => EditPopupVisible = false)" />
        <DxButton CssClass="popup-button my-1 ms-2" RenderStyle="ButtonRenderStyle.Secondary" Text="Cancel" Click="@(() => EditPopupVisible = false)" />
    </FooterContentTemplate>
</DxPopup>


<DxWindow Visible="@PdfModalVisible" VisibleChanged="@((value) => PdfModalVisible = value)" HeaderText="Belge Görüntüleme" Width="90vw" Height="85vh" AllowResize="true" ShowCloseButton="true" CloseOnEscape="true" HeaderCssClass="font-weight-bold">
    <BodyTemplate>
        <iframe src="@PdfDataUrl" style="width:100%; height:100%; border:none;"></iframe>
    </BodyTemplate>
</DxWindow>

<script>
    window.downloadFileFromBase64 = (fileName, base64String, contentType) => {
        const link = document.createElement('a');
        link.download = fileName;
        link.href = `data:${contentType};base64,${base64String}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
</script>

@code {
    [Parameter] public int Id { get; set; }
    private TenderModel? Model { get; set; }
    private bool IsSmallScreen { get; set; }
    private bool IsDataLoaded { get; set; }
    private int ActiveTabIndex { get; set; } = 0;
    private bool PdfModalVisible { get; set; }
    private string PdfDataUrl { get; set; } = "";
    private bool EditPopupVisible { get; set; }

    private GridDevExtremeDataSource<TenderOpexModel>? OpexDataSource { get; set; }
    private GridDevExtremeDataSource<TenderCapexModel>? CapexDataSource { get; set; }
    private GridDevExtremeDataSource<TenderReaktifModel>? ReaktifDataSource { get; set; }
    private GridDevExtremeDataSource<TenderRequiredDocument>? RequiredDocumentDataSource { get; set; }

    protected override async Task OnInitializedAsync()
    {
        IsDataLoaded = false;
        await LoadDataAsync();
        IsDataLoaded = true;
    }

    private async Task LoadDataAsync()
    {
        try
        {
            var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
            var response = await client.GetAsync($"api/tenders/{Id}");

            if (response.IsSuccessStatusCode)
            {
                Model = await response.Content.ReadFromJsonAsync<TenderModel>();
                await LoadTabData(ActiveTabIndex);
            }
            else
            {
                NavigationManager.NavigateTo("/tender/list");
            }
        }
        catch
        {
            NavigationManager.NavigateTo("/tender/list");
        }
    }

    private async Task OnActiveTabIndexChanged(int index)
    {
        ActiveTabIndex = index;
        await LoadTabData(index);
    }

    private async Task LoadTabData(int index)
    {
        var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
        string baseUrl = "https://localhost:7071/api";

        switch (index)
        {
            case 0:

                break;
            case 1:
                OpexDataSource = new GridDevExtremeDataSource<TenderOpexModel>(client, NavigationManager.ToAbsoluteUri($"{baseUrl}/tender-opex?tenderId={Id}"));
                break;
            case 2:
                CapexDataSource = new GridDevExtremeDataSource<TenderCapexModel>(client, NavigationManager.ToAbsoluteUri($"{baseUrl}/tender-capex?tenderId={Id}"));
                break;
            case 3:
                ReaktifDataSource = new GridDevExtremeDataSource<TenderReaktifModel>(client, NavigationManager.ToAbsoluteUri($"{baseUrl}/tender-reaktif?tenderId={Id}"));
                break;
            case 4:
                RequiredDocumentDataSource = new GridDevExtremeDataSource<TenderRequiredDocument>(client, NavigationManager.ToAbsoluteUri($"{baseUrl}/tender-documents?tenderId={Id}"));
                break;
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleFileAction(TenderRequiredDocument doc)
    {
        try
        {

            if (doc.FileContent == null) return;

            string base64String = Convert.ToBase64String(doc.FileContent);

            if (doc.FileType == "application/pdf")
            {
                PdfDataUrl = $"data:application/pdf;base64,{base64String}";
                PdfModalVisible = true;
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("downloadFileFromBase64", doc.FileName, base64String, doc.FileType);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }


    private async Task OnEditClick()
    {
        EditPopupVisible = true;
    }

    private async Task OnDeleteClick()
    {
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo("/tender/list");
    }
}