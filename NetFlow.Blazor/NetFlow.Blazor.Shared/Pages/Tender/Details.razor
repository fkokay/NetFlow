@page "/tender/details/{Id:int}"
@using System.Net.Http.Json
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IApiClientFactory ApiClientFactory
@inject IHttpClientFactory HttpClientFactory

<DxLayoutBreakpoint DeviceSize="DeviceSize.XSmall | DeviceSize.Small | DeviceSize.Medium" @bind-IsActive="@IsSmallScreen" />

<div class="content-root">
    <div class="card toolbar">
        <DxToolbar ItemRenderStyleMode="ToolbarRenderStyleMode.Plain">
            <DxToolbarItem IconCssClass="back-icon icon medium-icon" Tooltip="Go to Back" Click="@NavigateBack" />
            <DxToolbarItem>
                <Template>
                    <div class="custom-item">
                        <div class="title">İhale Detayı</div>
                    </div>
                </Template>
            </DxToolbarItem>
            <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                <Template>
                    <DxButton Text="Düzenle" Click="@OnEditClick" RenderStyleMode="ButtonRenderStyleMode.Outline" RenderStyle="ButtonRenderStyle.Danger" />
                </Template>
            </DxToolbarItem>
            <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                <Template>
                    <DxButton Text="Sil" Click="@OnDeleteClick" RenderStyleMode="ButtonRenderStyleMode.Outline" RenderStyle="ButtonRenderStyle.Danger" />
                </Template>
            </DxToolbarItem>
            <DxToolbarItem Alignment="ToolbarItemAlignment.Right" Click="@LoadDataAsync" Tooltip="Yenile" IconCssClass="refresh-icon icon medium-icon" />
        </DxToolbar>
    </div>

    <div class="tender-details">
        <DxLoadingPanel Visible="@(!IsDataLoaded)" IsContentBlocked="true" IsContentVisible="false" IndicatorVisible="true" IndicatorAreaVisible="true" ZIndex="101" Text="Yükleniyor...">
            <DxGridLayout ColumnSpacing="1rem" RowSpacing="1rem" CssClass="h-100">
                <Columns>
                    @if (!IsSmallScreen)
                    {
                        <DxGridLayoutColumn Width="1fr" />
                        <DxGridLayoutColumn Width="3fr" />
                    }
                    else
                    {
                        <DxGridLayoutColumn Width="100%" />
                    }
                </Columns>
                <Rows>
                    @if (!IsSmallScreen)
                    {
                        <DxGridLayoutRow Areas="item1 item2" />
                    }
                    else
                    {
                        <DxGridLayoutRow Areas="item1" />
                        <DxGridLayoutRow Areas="item2" />
                    }
                </Rows>
                <Items>
                    <DxGridLayoutItem Area="item1">
                        <Template>
                            @if (Model != null)
                            {
                                <div class="card h-100">
                                    <div class="authority-header">
                                        <div class="authority-avatar">
                                            @(!string.IsNullOrEmpty(Model.PublicAuthorityName)
                                                                                    ? Model.PublicAuthorityName[0].ToString().ToUpper()
                                                                                    : "?")
                                        </div>

                                        <h5 class="authority-title">
                                            @Model.PublicAuthorityName
                                        </h5>

                                        <span class="authority-badge">
                                            Müşteri No: #@Model.PublicAuthorityCode
                                        </span>
                                    </div>

                                    <div class="tender-stats">
                                        <div class="tender-stat">
                                            <i class="ti ti-gavel tender-icon-primary"></i>
                                            <div class="tender-stat-title">@Model.TenderCode</div>
                                            <small>İhale No</small>
                                        </div>

                                        <div class="tender-stat">
                                            <i class="ti ti-currency-dollar tender-icon-success"></i>
                                            <div class="tender-stat-title">
                                                @Model.TenderAmount.ToString("n2")
                                            </div>
                                            <small>@Model.Currency</small>
                                        </div>
                                    </div>

                                    <h6 class="tender-section-title">
                                        GENEL BİLGİLER
                                    </h6>

                                    <div class="tender-info">
                                        <div class="tender-info-row">
                                            <span>İhale:</span>
                                            <span class="tender-info-strong">@Model.TenderName</span>
                                        </div>
                                        <div class="tender-info-row">
                                            <span>Başlangıç:</span>
                                            <span>@Model.TenderStartDate.ToShortDateString()</span>
                                        </div>
                                        <div class="tender-info-row">
                                            <span>Bitiş:</span>
                                            <span>@Model.TenderEndDate.ToShortDateString()</span>
                                        </div>
                                        <div class="tender-info-row">
                                            <span>Tür:</span>
                                            <span>@Model.TenderType</span>
                                        </div>
                                        <div class="tender-info-row">
                                            <span>Metot:</span>
                                            <span>@Model.TenderMethod</span>
                                        </div>
                                        <div class="tender-info-row">
                                            <span>Sözleşme:</span>
                                            <span>@(Model.ContractDate?.ToShortDateString() ?? "-")</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </Template>
                    </DxGridLayoutItem>
                    <DxGridLayoutItem Area="item2">
                        <Template>
                            <DxTabs CssClass="card tabs">
                                <DxTabPage Text="Cihazlar" CssClass="tab-page">
                                    <TenderDevice TenderId="Id" />
                                </DxTabPage>
                                <DxTabPage Text="Opex" CssClass="tab-page">
                                    <TenderOpex TenderId="Id" />
                                </DxTabPage>
                                <DxTabPage Text="Capex" CssClass="tab-page">
                                    <TenderCapex TenderId="Id" />
                                </DxTabPage>
                                <DxTabPage Text="Reaktif" CssClass="tab-page">
                                    <TenderReaktif TenderId="Id" />
                                </DxTabPage>
                                <DxTabPage Text="Belgeler" CssClass="tab-page">
                                    <TenderDocuments TenderId="Id" />
                                </DxTabPage>
                            </DxTabs>
                        </Template>
                    </DxGridLayoutItem>
                </Items>
            </DxGridLayout>
        </DxLoadingPanel>
    </div>
</div>

<DxPopup @bind-Visible="@EditPopupVisible"
    ShowFooter="true"
    HeaderText="İhale Düzenleme">
    <BodyContentTemplate>
        <TenderEditForm />
    </BodyContentTemplate>
    <FooterContentTemplate>
        <DxButton CssClass="popup-button my-1 ms-2" RenderStyle="ButtonRenderStyle.Primary" Text="OK" Click="@(() => EditPopupVisible = false)" />
        <DxButton CssClass="popup-button my-1 ms-2" RenderStyle="ButtonRenderStyle.Secondary" Text="Cancel" Click="@(() => EditPopupVisible = false)" />
    </FooterContentTemplate>
</DxPopup>




@code {
    [Parameter] public int Id { get; set; }
    private TenderModel? Model { get; set; }
    private bool IsSmallScreen { get; set; }
    private bool IsDataLoaded { get; set; }
    private int ActiveTabIndex { get; set; } = 0;
    private bool EditPopupVisible { get; set; }


    protected override async Task OnInitializedAsync()
    {
        IsDataLoaded = false;
        await LoadDataAsync();
        IsDataLoaded = true;
    }

    private async Task LoadDataAsync()
    {
        try
        {
            var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
            var response = await client.GetAsync($"api/tenders/{Id}");

            if (response.IsSuccessStatusCode)
            {
                Model = await response.Content.ReadFromJsonAsync<TenderModel>();
                await LoadTabData(ActiveTabIndex);
            }
            else
            {
                NavigationManager.NavigateTo("/tender/list");
            }
        }
        catch
        {
            NavigationManager.NavigateTo("/tender/list");
        }
    }

    private async Task OnActiveTabIndexChanged(int index)
    {
        ActiveTabIndex = index;
        await LoadTabData(index);
    }

    private async Task LoadTabData(int index)
    {
        await InvokeAsync(StateHasChanged);
    }

  

    private async Task OnEditClick()
    {
        EditPopupVisible = true;
    }

    private async Task OnDeleteClick()
    {
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo("/tender/list");
    }
}