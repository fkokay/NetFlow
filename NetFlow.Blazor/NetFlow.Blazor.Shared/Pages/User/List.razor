@page "/user/list"
@implements IDisposable
@using System.Threading
@inject NavigationManager NavigationManager
@inject IApiClientFactory ApiClientFactory
@inject IHttpClientFactory HttpClientFactory

<div class="content-root">
    <div class="card toolbar">
        <DxToolbar Title="Kullanıcı Listesi" ItemRenderStyleMode="ToolbarRenderStyleMode.Plain">
            <DxToolbarItem Text="@UserRoleFilterValue" RenderStyleMode="ToolbarItemRenderStyleMode.Plain">
                <Items>
                    <DxToolbarItem Text="Tümü" Click="FilterByUserRole" />
                    @foreach (var role in UserRoles)
                    {
                        <DxToolbarItem Text="@role" Click="FilterByUserRole" />
                    }
                </Items>
            </DxToolbarItem>

            <DxToolbarItem Text="Yeni Kullanıcı"
                           Click="OnAddClick"
                           Alignment="ToolbarItemAlignment.Right"
                           IconCssClass="add-icon icon medium-icon" />

            <DxToolbarItem Tooltip="Sütun Seçici"
                           Alignment="ToolbarItemAlignment.Right"
                           Click="OnColumnChooserItemClick"
                           IconCssClass="column-chooser-icon icon medium-icon" />

            <DxToolbarItem Text="Dışarı Aktar"
                           Alignment="ToolbarItemAlignment.Right"
                           IconCssClass="export-icon icon medium-icon">
                <Items>
                    <DxToolbarItem Text="Export all data to Excel" Click="ExportAllDataToExcel" />
                    <DxToolbarItem Text="Export selected rows to Excel" Click="ExportSelectedRowsToExcel" />
                    <DxToolbarItem Text="Export all data to CSV" Click="ExportAllDataToCsv" />
                    <DxToolbarItem Text="Export selected rows to CSV" Click="ExportSelectedRowsDataToCsv" />
                    <DxToolbarItem Text="Export all data to PDF" Click="ExportAllDataToPdf" />
                    <DxToolbarItem Text="Export selected rows to PDF" Click="ExportSelectedRowsDataToPdf" />
                </Items>
            </DxToolbarItem>

            <DxToolbarItem Alignment="ToolbarItemAlignment.Right"
                           CssClass="search-textbox-item"
                           Tooltip="Search">
                <Template>
                    <DxSearchBox CssClass="search-textbox"
                                 NullText="Ara..."
                                 BindValueMode="BindValueMode.OnInput"
                                 ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                 @bind-Text="SearchText" />
                </Template>
            </DxToolbarItem>

            <DxToolbarItem Tooltip="Refresh"
                           BeginGroup="true"
                           Click="@LoadGridDataAsync"
                           Alignment="ToolbarItemAlignment.Right"
                           IconCssClass="refresh-icon icon medium-icon" />
        </DxToolbar>
    </div>

    <div class="User-list-root h-100">
        <DxGrid @ref="Grid"
                Data="Data"
                KeyFieldName="Id"
                CssClass="User-list"
                SearchText="@SearchText"
                EditMode="GridEditMode.PopupEditForm"
                SkeletonRowsEnabled="true"
                ColumnResizeMode="GridColumnResizeMode.NextColumn"
                FilterMenuButtonDisplayMode="GridFilterMenuButtonDisplayMode.Always"
                TextWrapEnabled="false"
                FocusedRowEnabled="true"
                ShowAllRows="true"
                VirtualScrollingEnabled="true"
                HighlightRowOnHover="true"
                RowClick="OnRowClick"
                EditStart="OnEditStart"
                DataItemDeleting="Grid_DataItemDeleting">

            <Columns>
                <DxGridSelectionColumn Width="75px" />
                <DxGridDataColumn FieldName="Id" Visible="false" />
                <DxGridDataColumn Caption="Ad" FieldName="FirstName" />
                <DxGridDataColumn Caption="Soyadı" FieldName="LastName" />
                <DxGridDataColumn Caption="Email" FieldName="Email" />
                <DxGridDataColumn Caption="Telefon" FieldName="Phone" />
                <DxGridDataColumn Caption="Aktif" FieldName="Active" />
                <DxGridDataColumn Caption="Firmalar" FieldName="Firms" />
                <DxGridDataColumn Caption="Roller" FieldName="Roles" />
                <DxGridCommandColumn Width="6em"
                                     DeleteButtonVisible="true"
                                     EditButtonVisible="true" />
            </Columns>
        </DxGrid>
    </div>
</div>

@code {
    CancellationTokenSource disposalTokenSource = new();

    [CascadingParameter(Name = "ParentSizeMode")]
    SizeMode SizeMode { get; set; }
    GridDevExtremeDataSource<UserModel> Data { get; set; } = null!;
    IGrid? Grid { get; set; }
    string? SearchText { get; set; }
    string UserRoleFilterValue { get; set; } = "Tümü";
    string[] UserRoles { get; } = { "Administrator", "Satış", "Satınalma", "Sevkiyat", "Kullanıcı" };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        await LoadGridDataAsync();
    }

    async Task LoadGridDataAsync()
    {
        var httpClient = HttpClientFactory.CreateClient("ApiClient");
        var client = await ApiClientFactory.CreateAsync(httpClient);
        // Not: DevExtremeDataSource için API endpoint'inizin LoadOptions desteklemesi önerilir.
        Data = new GridDevExtremeDataSource<UserModel>(client, NavigationManager.ToAbsoluteUri("https://localhost:7071/api/users"));

        if (Grid != null) Grid.Reload();
        await InvokeAsync(StateHasChanged);
    }

    // --- DÜZENLEME BUTONUNA BASINCA ÇALIŞACAK KISIM ---
    void OnEditStart(GridEditStartEventArgs e)
    {
        // 1. Grid'in varsayılan edit formunu/popubını açmasını engelle
        e.Cancel = true;

        // 2. İlgili satırın modelini al
        var user = (UserModel)e.DataItem;

        // 3. Düzenleme sayfasına yönlendir (örn: /user/edit/5)
        NavigationManager.NavigateTo($"/user/edit/{user.Id}");
    }
    // ------------------------------------------------

    async Task Grid_DataItemDeleting(GridDataItemDeletingEventArgs e)
    {
        e.Cancel = true;
        var user = (UserModel)e.DataItem;
        var httpClient = HttpClientFactory.CreateClient("ApiClient");
        var client = await ApiClientFactory.CreateAsync(httpClient);
        var response = await client.DeleteAsync($"api/users/{user.Id}");

        if (response.IsSuccessStatusCode)
        {
            await LoadGridDataAsync();
        }
    }

    void OnAddClick() => NavigationManager.NavigateTo("/user/create");

    void OnColumnChooserItemClick() => Grid?.ShowColumnChooser();

    void FilterByUserRole(ToolbarItemClickEventArgs item)
    {
        UserRoleFilterValue = item.Info.Text;
        Grid?.FilterBy(
            "Roles",
            GridFilterRowOperatorType.Contains,
            UserRoleFilterValue != "Tümü" ? UserRoleFilterValue : null
        );
    }

    void OnRowClick(GridRowClickEventArgs args) { }

    Task ExportAllDataToExcel() => Grid!.ExportToXlsxAsync("Users");
    Task ExportSelectedRowsToExcel() => Grid!.ExportToXlsxAsync("Selected Users", new() { ExportSelectedRowsOnly = true });
    Task ExportAllDataToCsv() => Grid!.ExportToCsvAsync("Users");
    Task ExportSelectedRowsDataToCsv() => Grid!.ExportToCsvAsync("Selected Users", new() { ExportSelectedRowsOnly = true });
    Task ExportAllDataToPdf() => Grid!.ExportToPdfAsync("Users");
    Task ExportSelectedRowsDataToPdf() => Grid!.ExportToPdfAsync("Selected Users", new() { ExportSelectedRowsOnly = true });

    public void Dispose()
    {
        disposalTokenSource.Cancel();
        disposalTokenSource.Dispose();
    }
}