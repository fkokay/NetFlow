@page "/user/create"
@using System.Net.Http.Json
@inject NavigationManager NavigationManager
@inject IApiClientFactory ApiClientFactory
@inject IHttpClientFactory HttpClientFactory

<div class="content-root">
    <div class="card toolbar">
        <DxToolbar ItemRenderStyleMode="ToolbarRenderStyleMode.Plain">
            <Items>
                <DxToolbarItem IconCssClass="back-icon icon medium-icon" Tooltip="Geri Dön" Click="@NavigateBack" />
                <DxToolbarItem>
                    <Template>
                        <div class="custom-item">
                            <div class="title">Kullanıcı Tanımlama</div>
                        </div>
                    </Template>
                </DxToolbarItem>
                <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                    <Template>
                        <DxButton Text="Kaydet"
                                  Click="SaveFromOutside"
                                  Enabled="!isSaving"
                                  RenderStyleMode="ButtonRenderStyleMode.Outline"
                                  RenderStyle="ButtonRenderStyle.Success" />
                    </Template>
                </DxToolbarItem>
            </Items>
        </DxToolbar>
    </div>

    <div class="user-create p-3">
        <EditForm EditContext="@editContext" Context="formContext">
            <DataAnnotationsValidator />

            <DxFormLayout>
                <DxFormLayoutItem Caption="Adı" ColSpanMd="6">
                    <DxTextBox @bind-Text="model.FirstName" ValidationEnabled="true" ShowValidationIcon="true" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Soyadı" ColSpanMd="6">
                    <DxTextBox @bind-Text="model.LastName" ValidationEnabled="true" ShowValidationIcon="true" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Telefon" ColSpanMd="6">
                    <DxTextBox @bind-Text="model.Phone" ValidationEnabled="true" ShowValidationIcon="true" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Mail" ColSpanMd="6">
                    <DxTextBox @bind-Text="model.Email" InputMode="InputMode.Email" ValidationEnabled="true" ShowValidationIcon="true" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Şifre" ColSpanMd="12">
                    <DxTextBox @bind-Text="model.Password" Password="true" ValidationEnabled="true" ShowValidationIcon="true" />
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="Yetkili Firmalar" ColSpanMd="12">
                    <DxTagBox TData="FirmSelectModel"
                              TValue="int"
                              Data="@Firms"
                              TextFieldName="FirmName"
                              ValueFieldName="Id"
                              Values="@model.FirmIds"
                              ValuesExpression="@(() => model.FirmIds)"
                              ValuesChanged="@((IEnumerable<int> values) => model.FirmIds = values.ToList())"
                              NullText="Firma seçiniz..."
                              ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
                </DxFormLayoutItem>

                <DxFormLayoutItem ColSpanMd="12">
                    <ValidationSummary />
                </DxFormLayoutItem>
            </DxFormLayout>
        </EditForm>
    </div>
</div>

@* Popup Bildirim *@
<DxPopup @bind-Visible="popupVisible"
         HeaderText="@popupTitle"
         Width="420px"
         ShowFooter="true"
         CloseOnOutsideClick="false">

    <HeaderTemplate>
        <div class="popup-notification-header @(isSuccess ? "success" : "danger")">
            <span class="popup-notification-header-title">
                @popupTitle
            </span>
        </div>
    </HeaderTemplate>

    <BodyTemplate>
        <div class="popup-notification-body">
            <div class="popup-notification-content">
                <h5 class="popup-notification-title">
                    @(isSuccess ? "İşlem Tamamlandı" : "Bir Hata Oluştu")
                </h5>
                <p class="popup-notification-message">
                    @popupMessage
                </p>
            </div>
        </div>
    </BodyTemplate>

    <FooterTemplate>
        <div class="popup-notification-footer">
            <DxButton Text="Kapat"
                      Width="110px"
                      RenderStyle="@(isSuccess ? ButtonRenderStyle.Success : ButtonRenderStyle.Danger)"
                      Click="OnPopupOk" />
        </div>
    </FooterTemplate>

</DxPopup>


@code {
    private UserModel model = new();
    private EditContext editContext = null!;
    private bool isSaving, popupVisible, isSuccess;
    private string popupTitle = "", popupMessage = "";
    private List<FirmSelectModel> Firms { get; set; } = new();

    protected override void OnInitialized()
    {
        model.FirmIds ??= new List<int>();
        editContext = new EditContext(model);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadFirmsAsync();
        }
    }

    private async Task LoadFirmsAsync()
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            var client = await ApiClientFactory.CreateAsync(httpClient);

            var result = await client.GetFromJsonAsync<List<FirmSelectModel>>("api/firms/simple");

            if (result != null)
            {
                Firms = result;
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Firma yükleme hatası: {ex.Message}");
        }
    }

    private async Task SaveFromOutside()
    {
        if (isSaving) return;
        if (editContext.Validate())
        {
            await HandleValidSubmit();
        }
    }

    private async Task HandleValidSubmit()
    {
        isSaving = true;
        try
        {
            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            var client = await ApiClientFactory.CreateAsync(httpClient);

            var response = await client.PostAsJsonAsync("api/users", model);

            isSuccess = response.IsSuccessStatusCode;
            popupTitle = isSuccess ? "Başarılı" : "Hata";

            if (!isSuccess)
                popupMessage = await response.Content.ReadAsStringAsync();
            else
                popupMessage = "Kullanıcı başarıyla oluşturuldu.";
        }
        catch (Exception ex)
        {
            isSuccess = false;
            popupTitle = "Bağlantı Hatası";
            popupMessage = ex.Message;
        }
        finally
        {
            isSaving = false;
            popupVisible = true;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void OnPopupOk()
    {
        popupVisible = false;
        if (isSuccess) NavigationManager.NavigateTo("/user/list");
    }

    private void NavigateBack() => NavigationManager.NavigateTo("/user/list");
}