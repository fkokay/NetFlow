@page "/material-request/details/{Id:int}"
@using System.Net.Http.Json
@inject NavigationManager NavigationManager
@inject IApiClientFactory ApiClientFactory
@inject IHttpClientFactory HttpClientFactory
@inject IToastNotificationService ToastService


<DxLayoutBreakpoint DeviceSize="DeviceSize.XSmall | DeviceSize.Small | DeviceSize.Medium"
                    @bind-IsActive="@IsSmallScreen" />

<div class="content-root">
    <div class="card toolbar">
        <DxToolbar ItemRenderStyleMode="ToolbarRenderStyleMode.Plain">

            <DxToolbarItem IconCssClass="back-icon icon medium-icon"
                           Tooltip="Geri"
                           Click="NavigateBack" />

            <DxToolbarItem>
                <Template>
                    <div class="custom-item">
                        <div class="title">Malzeme Talebi Detayı</div>
                    </div>
                </Template>
            </DxToolbarItem>

            @if (Model != null)
            {
                @if (Model.Status == MaterialRequestStatus.PendingApproval)
                {
                    <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                        <Template>
                            <DxButton Text="Onayla"
                                      Click="@OnApproveClick"
                                      RenderStyleMode="ButtonRenderStyleMode.Outline"
                                      RenderStyle="ButtonRenderStyle.Success" />
                        </Template>
                    </DxToolbarItem>

                    <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                        <Template>
                            <DxButton Text="Reddet"
                                      class="action-button-rejected"
                                      Click="@OnRejectClick"
                                      RenderStyleMode="ButtonRenderStyleMode.Outline"
                                      RenderStyle="ButtonRenderStyle.Danger" />
                        </Template>
                    </DxToolbarItem>
                }
                else if (Model.Status == MaterialRequestStatus.Open)
                {
                    <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                        <Template>
                            <DxButton Text="Talep Karşıla"
                                      class="action-button-rejected"
                                      Click="@OnDemandFulfillmentClick"
                                      RenderStyleMode="ButtonRenderStyleMode.Outline"
                                      RenderStyle="ButtonRenderStyle.Primary" />
                        </Template>
                    </DxToolbarItem>
                }

                <DxToolbarItem Alignment="ToolbarItemAlignment.Right"
                               Click="LoadDataAsync"
                               Tooltip="Yenile"
                               IconCssClass="refresh-icon icon medium-icon" />
            }
        </DxToolbar>
    </div>

    <DxLoadingPanel Visible="@(!IsDataLoaded)"
                    IsContentBlocked="true"
                    IsContentVisible="false"
                    Text="Yükleniyor...">

        <DxGridLayout ColumnSpacing="1rem" RowSpacing="1rem">
            <Columns>
                @if (!IsSmallScreen)
                {
                    <DxGridLayoutColumn Width="1fr" />
                    <DxGridLayoutColumn Width="3fr" />
                }
                else
                {
                    <DxGridLayoutColumn Width="100%" />
                }
            </Columns>

            <Rows>
                @if (!IsSmallScreen)
                {
                    <DxGridLayoutRow Areas="item1 item2" />
                }
                else
                {
                    <DxGridLayoutRow Areas="item1" />
                    <DxGridLayoutRow Areas="item2" />
                }
            </Rows>

            <Items>
                <DxGridLayoutItem Area="item1">
                    <Template>
                        @if (Model != null)
                        {
                            <div class="card h-100">
                                <div class="authority-header">
                                    <div class="authority-avatar">
                                        @Model.RequestNo[0]
                                    </div>

                                    <h5 class="authority-title">
                                        Talep No: @Model.RequestNo
                                    </h5>

                                    <span class="authority-badge">
                                        @(Model.Status.GetDescription())
                                    </span>
                                </div>

                                <div class="request-stats">
                                    <div class="request-stat">
                                        <div class="request-stat-title"> @(Model.RequestType.GetDescription())</div>
                                        <small>Talep Türü</small>
                                    </div>

                                    <div class="request-stat">
                                        <div class="request-stat-title">@(Model.Priority.GetDescription())</div>
                                        <small>Öncelik</small>
                                    </div>

                                    <div class="request-stat">
                                        <div class="request-stat-title">@Model.RequestedDepartment</div>
                                        <small>Departman</small>
                                    </div>
                                </div>


                                <h6 class="request-section-title">GENEL BİLGİLER</h6>

                                <div class="request-info">
                                    <div class="request-info-row">
                                        <span>Talep Tarihi:</span>
                                        <span>@Model.RequestDate.ToShortDateString()</span>
                                    </div>

                                    <div class="request-info-row">
                                        <span>Gerekli Tarih:</span>
                                        <span>
                                            <span class="@(Model.RequiredDate < DateTime.Today ? "text-danger" : "")">
                                                @Model.RequiredDate.ToShortDateString()
                                            </span>
                                        </span>
                                    </div>

                                    <div class="request-info-row">
                                        <span>Talep Eden:</span>
                                        <span>@Model.RequestedByUserId</span>
                                    </div>

                                    @if (Model.SourceType != MaterialRequestSourceType.None)
                                    {
                                        <div class="request-info-row">
                                            <span>Kaynak:</span>
                                            <span>@(Model.SourceType.GetDescription())</span>
                                        </div>
                                    }

                                    @if (!string.IsNullOrWhiteSpace(Model.Description))
                                    {
                                        <div class="request-info-row">
                                            <span>Açıklama:</span>
                                            <span>@Model.Description</span>
                                        </div>
                                    }
                                </div>

                                @if (Model.Status == MaterialRequestStatus.Approved)
                                {
                                    <h6 class="request-section-title">ONAY BİLGİSİ</h6>
                                    <div class="request-info">
                                        <div class="request-info-row">
                                            <span>Onaylayan:</span>
                                            <span>@Model.ApprovedByUserId</span>
                                        </div>
                                        <div class="request-info-row">
                                            <span>Onay Tarihi:</span>
                                            <span>@Model.ApprovalDate?.ToShortDateString()</span>
                                        </div>
                                    </div>
                                }

                                @if (Model.Status == MaterialRequestStatus.Rejected)
                                {
                                    <h6 class="request-section-title text-danger">RED NEDENİ</h6>
                                    <div class="request-info">
                                        <div class="request-info-row">
                                            <span>@Model.RejectionReason</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </Template>
                </DxGridLayoutItem>

                <DxGridLayoutItem Area="item2">
                    <Template>
                        <DxTabs CssClass="card tabs"
                                ActiveTabIndex="@ActiveTabIndex"
                                ActiveTabIndexChanged="OnActiveTabIndexChanged">

                            <DxTabPage Text="Talep Kalemleri">
                                <div class="card toolbar">
                                    <DxToolbar ItemRenderStyleMode="ToolbarRenderStyleMode.Plain">
                                        <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                                            <Template>
                                                <DxButton Text="Yeni Kalem Ekle" Click="OnAddNewItemClick" RenderStyleMode="ButtonRenderStyleMode.Outline" RenderStyle="ButtonRenderStyle.Danger" />
                                            </Template>
                                        </DxToolbarItem>
                                    </DxToolbar>
                                </div>

                                <DxGrid Data="ItemDataSource"
                                        ShowFilterRow="true"
                                        ColumnResizeMode="GridColumnResizeMode.ColumnsContainer"
                                        DataItemDeleting="Grid_DataItemDeleting"
                                        EditStart="Grid_EditStart">
                                    <Columns>
                                        <DxGridDataColumn FieldName="ItemCode" Caption="Kod" />
                                        <DxGridDataColumn FieldName="ItemName" Caption="Adı" />
                                        <DxGridDataColumn FieldName="RequestedQuantity" Caption="Talep" />
                                        <DxGridDataColumn FieldName="FulfilledQuantity" Caption="Karşılanan" />
                                        <DxGridDataColumn FieldName="Price" Caption="Fiyat" />
                                        <DxGridDataColumn FieldName="Unit" Caption="Birim" />
                                        <DxGridDataColumn FieldName="WarehouseCode" Caption="Depo" />
                                        <DxGridDataColumn Caption="Durum" FieldName="Status" Width="120px">
                                            <CellDisplayTemplate>
                                                <span class="status-badge">
                                                    @(((MaterialRequestItemModel)context.DataItem).Status.GetDescription())
                                                </span>
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>
                                        <DxGridDataColumn Caption="Karşılama Türü" FieldName="FulfillmentType" Width="120px">
                                            <CellDisplayTemplate>
                                                <span class="status-badge">
                                                    @(((MaterialRequestItemModel)context.DataItem).FulfillmentType.GetDescription())
                                                </span>
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>
                                        <DxGridCommandColumn Width="6em" DeleteButtonVisible="true" EditButtonVisible="true" />
                                    </Columns>
                                </DxGrid>
                            </DxTabPage>
                        </DxTabs>
                    </Template>
                </DxGridLayoutItem>
            </Items>
        </DxGridLayout>
    </DxLoadingPanel>
</div>


<MaterialFulfillmentComponent @bind-Visible="@IsFulfillmentPopupVisible"
                              RequestId="@Id"
                              IsEditable="@(Model?.Status == MaterialRequestStatus.Open)"
                              OnSuccess="LoadDataAsync" />


<MaterialRequestRejectionComponent @bind-Visible="IsRejectionPopupVisible"
                                   RequestId="@(Model?.Id ?? 0)"
                                   OnSuccess="LoadDataAsync" />
@if (IsItemCreateOrUpdatePopupVisible)
{
    <ItemCreateOrUpdateComponent @bind-Visible="IsItemCreateOrUpdatePopupVisible"
                                 RequestId="@(Model?.Id ?? 0)"
                                 MaterialRequestItemId="SelectedItemId"
                                 OnSuccess="LoadDataAsync" />
}





@code {
    [Parameter] public int Id { get; set; }

    private MaterialRequestModel? Model;
    private GridDevExtremeDataSource<MaterialRequestItemModel>? ItemDataSource;
    private bool IsSmallScreen;
    private bool IsDataLoaded;
    private int ActiveTabIndex;
    private bool AddPopupVisible { get; set; }
    private int? SelectedRequestId { get; set; }
    private bool IsRejectionPopupVisible { get; set; } = false;
    private bool IsFulfillmentPopupVisible { get; set; } = false;
    private bool IsItemCreateOrUpdatePopupVisible { get; set; } = false;
    int SelectedItemId;

    protected override async Task OnInitializedAsync()
    {
        IsDataLoaded = false;
        await LoadDataAsync();
        IsDataLoaded = true;
    }

    private async Task LoadDataAsync()
    {
        var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
        var response = await client.GetAsync($"api/material-requests/{Id}");

        if (!response.IsSuccessStatusCode)
        {
            NavigationManager.NavigateTo("/material-request/list");
            return;
        }

        Model = await response.Content.ReadFromJsonAsync<MaterialRequestModel>();
        await LoadTabData(ActiveTabIndex);
    }

    private async Task OnActiveTabIndexChanged(int index)
    {
        ActiveTabIndex = index;
        await LoadTabData(index);
    }

    private async Task LoadTabData(int index)
    {
        var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
        var baseUrl = "https://localhost:7071/api";

        if (index == 0)
        {
            ItemDataSource = new GridDevExtremeDataSource<MaterialRequestItemModel>(
                client,
                NavigationManager.ToAbsoluteUri($"{baseUrl}/material-request-items?materialRequestId={Id}")
            );
        }
        await InvokeAsync(StateHasChanged);
    }






    //Onay Reddet Karşılama Butonları
    private async Task OnApproveClick()
    {
        try
        {
            IsDataLoaded = false;
            await InvokeAsync(StateHasChanged);

            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            var client = await ApiClientFactory.CreateAsync(httpClient);

            var response = await client.PutAsync($"https://localhost:7071/api/material-requests/approved/{Id}", null);

            if (response.IsSuccessStatusCode)
            {
                await LoadDataAsync();
                ShowToast("Başarılı", "Talep başarıyla onaylandı.", ToastRenderStyle.Success, false);
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                ShowToast("Hata", errorMsg, ToastRenderStyle.Danger, true);
            }
        }
        catch (Exception ex)
        {
            ShowToast("Hata", ex.Message, ToastRenderStyle.Danger, true);
        }
        finally
        {
            IsDataLoaded = true;
            await InvokeAsync(StateHasChanged);
        }
    }
    private void OnRejectClick()
    {
        IsRejectionPopupVisible = true;
    }
    private void OnDemandFulfillmentClick() => IsFulfillmentPopupVisible = true;
   

    


    //Kalem Ekleme Silme Düzenleme
    async Task OnAddNewItemClick()
    {
        SelectedItemId = 0;
        IsItemCreateOrUpdatePopupVisible = false;
        await Task.Yield();
        IsItemCreateOrUpdatePopupVisible = true;
    }
    async Task Grid_EditStart(GridEditStartEventArgs e)
    {

        e.Cancel = true;

        var editModel = (MaterialRequestItemModel)e.DataItem;
        SelectedItemId = editModel.Id;
        IsItemCreateOrUpdatePopupVisible = true;
        StateHasChanged();
        await Task.CompletedTask;
    }
    async Task Grid_DataItemDeleting(GridDataItemDeletingEventArgs e)
    {
        e.Cancel = true;
        var requestItem = (MaterialRequestItemModel)e.DataItem;
        try
        {
            IsDataLoaded = false;
            await InvokeAsync(StateHasChanged);

            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            var client = await ApiClientFactory.CreateAsync(httpClient);
            var response = await client.DeleteAsync($"api/material-request-items/{requestItem.Id}");

            if (response.IsSuccessStatusCode)
            {
                await LoadDataAsync();
                ShowToast("Başarılı", "Kalem başarıyla silindi.", ToastRenderStyle.Success, false);
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                ShowToast("Hata", errorMsg, ToastRenderStyle.Danger, true);
            }
        }
        catch (Exception ex)
        {
            ShowToast("Hata", ex.Message, ToastRenderStyle.Danger, true);
        }
        finally
        {
            IsDataLoaded = true;
            await InvokeAsync(StateHasChanged);
        }
    }




    private void ShowToast(string title, string text, ToastRenderStyle style, bool isError)
    {
        ToastService.ShowToast(new ToastOptions()
        {
            Id = "toast",
            ProviderName = "Overview",
            ThemeMode = ToastThemeMode.Light,
            RenderStyle = style,
            Title = title,
            Text = text,
        }, RenderToastButton(isError));
    }

    private RenderFragment RenderToastButton(bool isError) =>
        @<div class="d-flex gap-2">
        <DxButton Click="@(isError? OnPopupError : OnPopupOk)"
                  RenderStyle="@(isError ? ButtonRenderStyle.Danger : ButtonRenderStyle.Success)">Kapat</DxButton>
    </div>;

    private void OnPopupOk() => NavigationManager.NavigateTo("/material-request/list");
    private void OnPopupError() { }
    private void OnCancelRejection() => IsRejectionPopupVisible = false;
    private void NavigateBack() => NavigationManager.NavigateTo("/material-request/list");
}
