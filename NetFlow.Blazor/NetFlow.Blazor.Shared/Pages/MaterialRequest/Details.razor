@page "/material-request/details/{Id:int}"
@using System.Net.Http.Json
@inject NavigationManager NavigationManager
@inject IApiClientFactory ApiClientFactory
@inject IHttpClientFactory HttpClientFactory
@inject IToastNotificationService ToastService


<DxLayoutBreakpoint DeviceSize="DeviceSize.XSmall | DeviceSize.Small | DeviceSize.Medium"
                    @bind-IsActive="@IsSmallScreen" />


<DxPopup @bind-Visible="@IsRejectionPopupVisible"
         ShowFooter="true"
         HeaderText="Talebi Reddet"
         Width="600px"
         MaxWidth="95vw">
    <BodyContentTemplate Context="popupContext">
        @if (IsRejectionPopupVisible)
        {
            <div class="rejection-popup-container">
                <DxFormLayout CaptionPosition="CaptionPosition.Vertical">
                    <DxFormLayoutItem Caption="Reddetme Nedeni" ColSpanMd="12">
                        <DxMemo @bind-Text="@RejectionReason"
                                Rows="5"
                                BindValueMode="BindValueMode.OnInput"
                                NullText="Reddetme nedenini detaylıca giriniz..."
                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />

                        @if (string.IsNullOrWhiteSpace(RejectionReason))
                        {
                            <small class="text-danger mt-1">Bu alanın doldurulması zorunludur.</small>
                        }
                    </DxFormLayoutItem>
                </DxFormLayout>
            </div>
        }
    </BodyContentTemplate>

    <FooterContentTemplate Context="footerContext">
        <DxButton RenderStyle="ButtonRenderStyle.Danger"
                  Text="Reddi Onayla"
                  IconCssClass="dx-icon-check"
                  Enabled="@(!string.IsNullOrWhiteSpace(RejectionReason))"
                  Click="OnConfirmRejection" />

        <DxButton RenderStyle="ButtonRenderStyle.Secondary"
                  Text="Vazgeç"
                  IconCssClass="dx-icon-close"
                  Click="OnCancelRejection" />
    </FooterContentTemplate>
</DxPopup>

<DemandFulfillmentPopup @bind-Visible="@IsDemandFulfillmentPopupVisible"
                        OnConfirmClick="HandleFulfillmentConfirm" />


<div class="content-root">
    <div class="card toolbar">
        <DxToolbar ItemRenderStyleMode="ToolbarRenderStyleMode.Plain">

            <DxToolbarItem IconCssClass="back-icon icon medium-icon"
                           Tooltip="Geri"
                           Click="NavigateBack" />

            <DxToolbarItem>
                <Template>
                    <div class="custom-item">
                        <div class="title">Malzeme Talebi Detayı</div>
                    </div>
                </Template>
            </DxToolbarItem>

            @if (Model != null)
            {
                var status = Model.Status?.ToLower();

                @if (status == "waiting")
                {
                    <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                        <Template>
                            <DxButton Text="Onayla"
                                      Click="@OnApproveClick"
                                      RenderStyleMode="ButtonRenderStyleMode.Outline"
                                      RenderStyle="ButtonRenderStyle.Success" />
                        </Template>
                    </DxToolbarItem>

                    <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                        <Template>
                            <DxButton Text="Reddet"
                                      class="action-button-rejected"
                                      Click="@OnRejectClick"
                                      RenderStyleMode="ButtonRenderStyleMode.Outline"
                                      RenderStyle="ButtonRenderStyle.Danger" />
                        </Template>
                    </DxToolbarItem>
                }
                else if (status == "open")
                {
                    <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                        <Template>
                            <DxButton Text="Talep Karşıla"
                                      class="action-button-rejected"
                                      Click="@OnDemandFulfillmentClick"
                                      RenderStyleMode="ButtonRenderStyleMode.Outline"
                                      RenderStyle="ButtonRenderStyle.Primary" />
                        </Template>
                    </DxToolbarItem>
                }


                <DxToolbarItem Alignment="ToolbarItemAlignment.Right"
                               Click="LoadDataAsync"
                               Tooltip="Yenile"
                               IconCssClass="refresh-icon icon medium-icon" />
            }

        </DxToolbar>
    </div>

    <DxLoadingPanel Visible="@(!IsDataLoaded)"
                    IsContentBlocked="true"
                    IsContentVisible="false"
                    Text="Yükleniyor...">

        <DxGridLayout ColumnSpacing="1rem" RowSpacing="1rem">

            <Columns>
                @if (!IsSmallScreen)
                {
                    <DxGridLayoutColumn Width="1fr" />
                    <DxGridLayoutColumn Width="3fr" />
                }
                else
                {
                    <DxGridLayoutColumn Width="100%" />
                }
            </Columns>

            <Rows>
                @if (!IsSmallScreen)
                {
                    <DxGridLayoutRow Areas="item1 item2" />
                }
                else
                {
                    <DxGridLayoutRow Areas="item1" />
                    <DxGridLayoutRow Areas="item2" />
                }
            </Rows>

            <Items>

                <DxGridLayoutItem Area="item1">
                    <Template>
                        @if (Model != null)
                        {
                            <div class="card h-100">
                                <div class="authority-header">
                                    <div class="authority-avatar">
                                        @Model.RequestNo[0]
                                    </div>

                                    <h5 class="authority-title">
                                        Talep No: @Model.RequestNo
                                    </h5>

                                    <span class="authority-badge">
                                        @Model.Status
                                    </span>
                                </div>

                                <div class="request-stats">
                                    <div class="request-stat">
                                        <div class="request-stat-title">
                                            @Model.RequestType
                                        </div>
                                        <small>Talep Türü</small>
                                    </div>

                                    <div class="request-stat">
                                        <div class="request-stat-title">
                                            @Model.Priority
                                        </div>
                                        <small>Öncelik</small>
                                    </div>
                                </div>

                                <h6 class="request-section-title">GENEL BİLGİLER</h6>

                                <div class="request-info">
                                    <div class="request-info-row">
                                        <span>Talep Tarihi:</span>
                                        <span>@Model.RequestDate.ToShortDateString()</span>
                                    </div>
                                    <div class="request-info-row">
                                        <span>Gerekli Tarih:</span>
                                        <span>@Model.RequiredDate?.ToShortDateString()</span>
                                    </div>
                                    <div class="request-info-row">
                                        <span>Departman:</span>
                                        <span>@Model.RequestedDepartment</span>
                                    </div>
                                    <div class="request-info-row">
                                        <span>Açıklama:</span>
                                        <span>@Model.Description</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </Template>
                </DxGridLayoutItem>


                <DxGridLayoutItem Area="item2">
                    <Template>
                        <DxTabs CssClass="card tabs"
                                ActiveTabIndex="@ActiveTabIndex"
                                ActiveTabIndexChanged="OnActiveTabIndexChanged">

                            <DxTabPage Text="Talep Kalemleri">
                                <DxGrid Data="ItemDataSource"
                                        ShowFilterRow="true"
                                        ColumnResizeMode="GridColumnResizeMode.ColumnsContainer">

                                    <Columns>
                                        <DxGridDataColumn FieldName="ItemCode" Caption="Kod" />
                                        <DxGridDataColumn FieldName="ItemName" Caption="Adı" />
                                        <DxGridDataColumn FieldName="RequestedQuantity" Caption="Talep" />
                                        <DxGridDataColumn FieldName="FulfilledQuantity" Caption="Karşılanan" />
                                        <DxGridDataColumn FieldName="Unit" Caption="Birim" />
                                        <DxGridDataColumn FieldName="WarehouseCode" Caption="Depo" />
                                        <DxGridDataColumn FieldName="Status" Caption="Durum" />
                                    </Columns>

                                </DxGrid>
                            </DxTabPage>

                        </DxTabs>
                    </Template>
                </DxGridLayoutItem>

            </Items>
        </DxGridLayout>
    </DxLoadingPanel>
</div>

@code {
    [Parameter] public int Id { get; set; }

    private MaterialRequestModel? Model;
    private GridDevExtremeDataSource<MaterialRequestItemModel>? ItemDataSource;
    private bool IsSaving, IsSuccess;
    private bool IsSmallScreen;
    private bool IsDataLoaded;
    private int ActiveTabIndex;

    bool IsRejectionPopupVisible { get; set; } = false;
    bool IsDemandFulfillmentPopupVisible { get; set; } = false;
    int SelectedMaterialId { get; set; }
    string? RejectionReason { get; set; } = "";

    protected override async Task OnInitializedAsync()
    {
        IsDataLoaded = false;
        await LoadDataAsync();
        IsDataLoaded = true;
    }

    private async Task LoadDataAsync()
    {
        var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
        var response = await client.GetAsync($"api/material-requests/{Id}");

        if (!response.IsSuccessStatusCode)
        {
            NavigationManager.NavigateTo("/material-request/list");
            return;
        }

        Model = await response.Content.ReadFromJsonAsync<MaterialRequestModel>();
        await LoadTabData(ActiveTabIndex);
    }

    private async Task OnActiveTabIndexChanged(int index)
    {
        ActiveTabIndex = index;
        await LoadTabData(index);
    }

    private async Task LoadTabData(int index)
    {
        var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
        var baseUrl = "https://localhost:7071/api";

        if (index == 0)
        {
            ItemDataSource = new GridDevExtremeDataSource<MaterialRequestItemModel>(
                client,
                NavigationManager.ToAbsoluteUri($"{baseUrl}/material-request-items?materialRequestId={Id}")
            );
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnApproveClick()
    {
        try
        {
            IsDataLoaded = false;
            await InvokeAsync(StateHasChanged);

            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            var client = await ApiClientFactory.CreateAsync(httpClient);

            var response = await client.PutAsync(
                $"https://localhost:7071/api/material-requests/approved/{Id}",
                null
            );

            if (response.IsSuccessStatusCode)
            {
                await LoadDataAsync();

                IsSuccess = true;
                ToastService.ShowToast(new ToastOptions()
                {
                    Id = "toast",
                    ProviderName = "Overview",
                    ThemeMode = ToastThemeMode.Light,
                    RenderStyle = ToastRenderStyle.Success,
                    Title = "Başarılı",
                    Text = "Talep başarıyla onaylandı."
                }, RenderToastButton(false));
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                ToastService.ShowToast(new ToastOptions()
                {
                    Title = "Hata",
                    Text = errorMsg,
                    RenderStyle = ToastRenderStyle.Warning
                }, RenderToastButton(true));
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast(new ToastOptions()
            {
                Title = "Hata",
                Text = ex.Message,
                RenderStyle = ToastRenderStyle.Danger
            }, RenderToastButton(true));
        }
        finally
        {
            IsDataLoaded = true;
            await InvokeAsync(StateHasChanged);
        }
    }


    private async Task OnDemandFulfillmentClick()
    {
        IsDemandFulfillmentPopupVisible = true;
        await Task.CompletedTask;
    }

    private async Task HandleFulfillmentConfirm()
    {
        IsSuccess = true;
        IsDemandFulfillmentPopupVisible = false;
        await Task.CompletedTask;
    }

    private RenderFragment RenderToastButton(bool isError) =>
        @<div class="d-flex gap-2">
        <DxButton Click="@(isError? OnPopupError : OnPopupOk)"
                  RenderStyle="@(isError ? ButtonRenderStyle.Danger : ButtonRenderStyle.Success)">Kapat</DxButton>
    </div>;

    private void OnPopupOk() { if (IsSuccess) NavigationManager.NavigateTo("/material-request/list"); }
    private void OnPopupError() { }

    private Task OnRejectClick()
    {
        if (Model != null)
        {
            SelectedMaterialId = Model.Id;
            RejectionReason = string.Empty;
            IsRejectionPopupVisible = true;
        }
        return Task.CompletedTask;
    }

    void OnCancelRejection() => IsRejectionPopupVisible = false;

    async Task OnConfirmRejection()
    {
        try
        {
            IsDataLoaded = false;
            IsRejectionPopupVisible = false;
            await InvokeAsync(StateHasChanged);
            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            var client = await ApiClientFactory.CreateAsync(httpClient);

            var model = new
            {
                Id = SelectedMaterialId,
                RejectionReason = RejectionReason
            };

            var response = await client.PutAsJsonAsync(
                $"https://localhost:7071/api/material-requests/rejection",
                model
            );

            if (response.IsSuccessStatusCode)
            {
                await LoadDataAsync();
                IsSuccess = true;

                ToastService.ShowToast(new ToastOptions()
                {
                    Id = "toast",
                    ProviderName = "Overview",
                    ThemeMode = ToastThemeMode.Light,
                    RenderStyle = ToastRenderStyle.Success,
                    Title = "Başarılı",
                    Text = "Talep reddedildi."
                }, RenderToastButton(false));
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                ToastService.ShowToast(new ToastOptions()
                {
                    Id = "toast",
                    ProviderName = "Overview",
                    ThemeMode = ToastThemeMode.Light,
                    RenderStyle = ToastRenderStyle.Danger,
                    Title = "Hata",
                    Text = errorMsg
                }, RenderToastButton(true));
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast(new ToastOptions()
            {
                Title = "Hata",
                Text = ex.Message,
                RenderStyle = ToastRenderStyle.Danger
            }, RenderToastButton(true));
        }
        finally
        {
            IsDataLoaded = true;
            await InvokeAsync(StateHasChanged);
        }
    }


    private void NavigateBack() => NavigationManager.NavigateTo("/material-request/list");
}