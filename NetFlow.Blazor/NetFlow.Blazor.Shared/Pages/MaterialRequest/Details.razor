@page "/material-request/details/{Id:int}"
@using System.Net.Http.Json
@inject NavigationManager NavigationManager
@inject IApiClientFactory ApiClientFactory
@inject IHttpClientFactory HttpClientFactory
@inject IToastNotificationService ToastService


<DxLayoutBreakpoint DeviceSize="DeviceSize.XSmall | DeviceSize.Small | DeviceSize.Medium"
                    @bind-IsActive="@IsSmallScreen" />


<DxPopup @bind-Visible="@IsRejectionPopupVisible"
         ShowFooter="true"
         HeaderText="Talebi Reddet"
         Width="600px"
         MaxWidth="95vw">
    <BodyContentTemplate Context="popupContext">
        @if (IsRejectionPopupVisible)
        {
            <div class="rejection-popup-container">
                <DxFormLayout CaptionPosition="CaptionPosition.Vertical">
                    <DxFormLayoutItem Caption="Reddetme Nedeni" ColSpanMd="12">
                        <DxMemo @bind-Text="@RejectionReason"
                                Rows="5"
                                BindValueMode="BindValueMode.OnInput"
                                NullText="Reddetme nedenini detaylıca giriniz..."
                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />

                        @if (string.IsNullOrWhiteSpace(RejectionReason))
                        {
                            <small class="text-danger mt-1">Bu alanın doldurulması zorunludur.</small>
                        }
                    </DxFormLayoutItem>
                </DxFormLayout>
            </div>
        }
    </BodyContentTemplate>

    <FooterContentTemplate Context="footerContext">
        <DxButton RenderStyle="ButtonRenderStyle.Danger"
                  Text="Reddi Onayla"
                  IconCssClass="dx-icon-check"
                  Enabled="@(!string.IsNullOrWhiteSpace(RejectionReason))"
                  Click="OnConfirmRejection" />

        <DxButton RenderStyle="ButtonRenderStyle.Secondary"
                  Text="Vazgeç"
                  IconCssClass="dx-icon-close"
                  Click="OnCancelRejection" />
    </FooterContentTemplate>
</DxPopup>

<DxPopup @bind-Visible="@IsFulfillmentPopupVisible"
         HeaderText="Talep Karşıla"
         Width="900px"
         ShowFooter="true">
    <BodyContentTemplate Context="fulfillmentContext">
        <DxGrid Data="FulfillmentItems" PageSize="10">
            <Columns>
                <DxGridDataColumn FieldName="ItemCode" Caption="Kod" Width="120px" />
                <DxGridDataColumn FieldName="ItemName" Caption="Adı" />

                <DxGridDataColumn Caption="Talep Miktar" Width="150px">
                    <CellDisplayTemplate>
                        @{
                            var item = (MaterialRequestItemModel)context.DataItem;
                            if (!SelectedRequestedQuantities.ContainsKey(item.Id))
                            {
                                SelectedRequestedQuantities[item.Id] = item.RequestedQuantity;
                            }
                        }
                        <DxSpinEdit Value="@SelectedRequestedQuantities[item.Id]"
                                    T="decimal"
                                    ReadOnly="true"
                                    Enabled="false"
                                    Mask="@NumericMask.RealNumber" />
                    </CellDisplayTemplate>
                </DxGridDataColumn>

                <DxGridDataColumn Caption="Karşılanan Miktar" Width="150px">
                    <CellDisplayTemplate>
                        @{
                            var item = (MaterialRequestItemModel)context.DataItem;
                            if (!SelectedFulfillmentQuantities.ContainsKey(item.Id))
                            {
                                SelectedFulfillmentQuantities[item.Id] = item.FulfilledQuantity;
                            }
                        }
                        <DxSpinEdit Value="@SelectedFulfillmentQuantities[item.Id]"
                                    T="decimal"
                                    ValueChanged="@((decimal newVal) => { SelectedFulfillmentQuantities[item.Id] = newVal; })"
                                    Mask="@NumericMask.RealNumber"
                                    Enabled="@(Model?.Status.GetDescription()?.ToLower() == "talep açıldı")"
                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto" />
                    </CellDisplayTemplate>
                </DxGridDataColumn>

                <DxGridDataColumn FieldName="Unit" Caption="Birim" Width="80px" />

                <DxGridDataColumn Caption="Karşılama Yöntemi" Width="200px">
                    <CellDisplayTemplate>
                        @{
                            var item = (MaterialRequestItemModel)context.DataItem;

                            if (!SelectedFulfillmentTypes.ContainsKey(item.Id))
                            {
                                SelectedFulfillmentTypes[item.Id] = item.FulfillmentType;
                            }
                        }

                        <DxComboBox Data="@FulfillmentTypes"
                                    Value="@SelectedFulfillmentTypes[item.Id]"
                                    ValueChanged="@((MaterialRequestItemFulfillmentType val) => SelectedFulfillmentTypes[item.Id] = val)"
                                    TextFieldName="Text"
                                    ValueFieldName="Value"
                                    Enabled="@(Model?.Status.GetDescription()?.ToLower() == "talep açıldı")" />
                    </CellDisplayTemplate>
                </DxGridDataColumn>
            </Columns>
        </DxGrid>
    </BodyContentTemplate>

    <FooterContentTemplate Context="fFooter">
        <DxButton RenderStyle="ButtonRenderStyle.Primary"
                  Text="Seçimleri Gönder"
                  IconCssClass="dx-icon-check"
                  Click="OnConfirmFulfillment" />

        <DxButton RenderStyle="ButtonRenderStyle.Secondary"
                  Text="Vazgeç"
                  IconCssClass="dx-icon-close"
                  Click="@(() => IsFulfillmentPopupVisible = false)" />
    </FooterContentTemplate>
</DxPopup>



<div class="content-root">
    <div class="card toolbar">
        <DxToolbar ItemRenderStyleMode="ToolbarRenderStyleMode.Plain">

            <DxToolbarItem IconCssClass="back-icon icon medium-icon"
                           Tooltip="Geri"
                           Click="NavigateBack" />

            <DxToolbarItem>
                <Template>
                    <div class="custom-item">
                        <div class="title">Malzeme Talebi Detayı</div>
                    </div>
                </Template>
            </DxToolbarItem>

            @if (Model != null)
            {
                @if (Model.Status == MaterialRequestStatus.PendingApproval)
                {
                    <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                        <Template>
                            <DxButton Text="Onayla"
                                      Click="@OnApproveClick"
                                      RenderStyleMode="ButtonRenderStyleMode.Outline"
                                      RenderStyle="ButtonRenderStyle.Success" />
                        </Template>
                    </DxToolbarItem>

                    <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                        <Template>
                            <DxButton Text="Reddet"
                                      class="action-button-rejected"
                                      Click="@OnRejectClick"
                                      RenderStyleMode="ButtonRenderStyleMode.Outline"
                                      RenderStyle="ButtonRenderStyle.Danger" />
                        </Template>
                    </DxToolbarItem>
                }
                else if (Model.Status == MaterialRequestStatus.Open)
                {
                    <DxToolbarItem Alignment="ToolbarItemAlignment.Right">
                        <Template>
                            <DxButton Text="Talep Karşıla"
                                      class="action-button-rejected"
                                      Click="@OnDemandFulfillmentClick"
                                      RenderStyleMode="ButtonRenderStyleMode.Outline"
                                      RenderStyle="ButtonRenderStyle.Primary" />
                        </Template>
                    </DxToolbarItem>
                }

                <DxToolbarItem Alignment="ToolbarItemAlignment.Right"
                               Click="LoadDataAsync"
                               Tooltip="Yenile"
                               IconCssClass="refresh-icon icon medium-icon" />
            }
        </DxToolbar>
    </div>

    <DxLoadingPanel Visible="@(!IsDataLoaded)"
                    IsContentBlocked="true"
                    IsContentVisible="false"
                    Text="Yükleniyor...">

        <DxGridLayout ColumnSpacing="1rem" RowSpacing="1rem">
            <Columns>
                @if (!IsSmallScreen)
                {
                    <DxGridLayoutColumn Width="1fr" />
                    <DxGridLayoutColumn Width="3fr" />
                }
                else
                {
                    <DxGridLayoutColumn Width="100%" />
                }
            </Columns>

            <Rows>
                @if (!IsSmallScreen)
                {
                    <DxGridLayoutRow Areas="item1 item2" />
                }
                else
                {
                    <DxGridLayoutRow Areas="item1" />
                    <DxGridLayoutRow Areas="item2" />
                }
            </Rows>

            <Items>
                <DxGridLayoutItem Area="item1">
                    <Template>
                        @if (Model != null)
                        {
                            <div class="card h-100">
                                <div class="authority-header">
                                    <div class="authority-avatar">
                                        @Model.RequestNo[0]
                                    </div>

                                    <h5 class="authority-title">
                                        Talep No: @Model.RequestNo
                                    </h5>

                                    <span class="authority-badge">
                                        @(Model.Status.GetDescription())
                                    </span>
                                </div>

                                <div class="request-stats">
                                    <div class="request-stat">
                                        <div class="request-stat-title"> @(Model.RequestType.GetDescription())</div>
                                        <small>Talep Türü</small>
                                    </div>

                                    <div class="request-stat">
                                        <div class="request-stat-title">@(Model.Priority.GetDescription())</div>
                                        <small>Öncelik</small>
                                    </div>

                                    <div class="request-stat">
                                        <div class="request-stat-title">@Model.RequestedDepartment</div>
                                        <small>Departman</small>
                                    </div>
                                </div>


                                <h6 class="request-section-title">GENEL BİLGİLER</h6>

                                <div class="request-info">
                                    <div class="request-info-row">
                                        <span>Talep Tarihi:</span>
                                        <span>@Model.RequestDate.ToShortDateString()</span>
                                    </div>

                                    <div class="request-info-row">
                                        <span>Gerekli Tarih:</span>
                                        <span>
                                            <span class="@(Model.RequiredDate < DateTime.Today ? "text-danger" : "")">
                                                @Model.RequiredDate.ToShortDateString()
                                            </span>
                                        </span>
                                    </div>

                                    <div class="request-info-row">
                                        <span>Talep Eden:</span>
                                        <span>@Model.RequestedByUserId</span>
                                    </div>

                                    @if (Model.SourceType != MaterialRequestSourceType.None)
                                    {
                                        <div class="request-info-row">
                                            <span>Kaynak:</span>
                                            <span>@(Model.SourceType.GetDescription())</span>
                                        </div>
                                    }

                                    @if (!string.IsNullOrWhiteSpace(Model.Description))
                                    {
                                        <div class="request-info-row">
                                            <span>Açıklama:</span>
                                            <span>@Model.Description</span>
                                        </div>
                                    }
                                </div>

                                @if (Model.Status == MaterialRequestStatus.Approved)
                                {
                                    <h6 class="request-section-title">ONAY BİLGİSİ</h6>
                                    <div class="request-info">
                                        <div class="request-info-row">
                                            <span>Onaylayan:</span>
                                            <span>@Model.ApprovedByUserId</span>
                                        </div>
                                        <div class="request-info-row">
                                            <span>Onay Tarihi:</span>
                                            <span>@Model.ApprovalDate?.ToShortDateString()</span>
                                        </div>
                                    </div>
                                }

                                @if (Model.Status == MaterialRequestStatus.Rejected)
                                {
                                    <h6 class="request-section-title text-danger">RED NEDENİ</h6>
                                    <div class="request-info">
                                        <div class="request-info-row">
                                            <span>@Model.RejectionReason</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </Template>
                </DxGridLayoutItem>

                <DxGridLayoutItem Area="item2">
                    <Template>
                        <DxTabs CssClass="card tabs"
                                ActiveTabIndex="@ActiveTabIndex"
                                ActiveTabIndexChanged="OnActiveTabIndexChanged">

                            <DxTabPage Text="Talep Kalemleri">
                                <DxGrid Data="ItemDataSource"
                                        ShowFilterRow="true"
                                        ColumnResizeMode="GridColumnResizeMode.ColumnsContainer">
                                    <Columns>
                                        <DxGridDataColumn FieldName="ItemCode" Caption="Kod" />
                                        <DxGridDataColumn FieldName="ItemName" Caption="Adı" />
                                        <DxGridDataColumn FieldName="RequestedQuantity" Caption="Talep" />
                                        <DxGridDataColumn FieldName="FulfilledQuantity" Caption="Karşılanan" />
                                        <DxGridDataColumn FieldName="Unit" Caption="Birim" />
                                        <DxGridDataColumn FieldName="WarehouseCode" Caption="Depo" />
                                        <DxGridDataColumn Caption="Durum" FieldName="Status" Width="120px">
                                            <CellDisplayTemplate>
                                                <span class="status-badge">
                                                    @(((MaterialRequestItemModel)context.DataItem).Status.GetDescription())
                                                </span>
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>
                                        <DxGridDataColumn Caption="Karşılama Türü" FieldName="FulfillmentType" Width="120px">
                                            <CellDisplayTemplate>
                                                <span class="status-badge">
                                                    @(((MaterialRequestItemModel)context.DataItem).FulfillmentType.GetDescription())
                                                </span>
                                            </CellDisplayTemplate>
                                        </DxGridDataColumn>
                                    </Columns>
                                </DxGrid>
                            </DxTabPage>
                        </DxTabs>
                    </Template>
                </DxGridLayoutItem>
            </Items>
        </DxGridLayout>
    </DxLoadingPanel>
</div>

@code {
    [Parameter] public int Id { get; set; }

    private MaterialRequestModel? Model;
    private GridDevExtremeDataSource<MaterialRequestItemModel>? ItemDataSource;
    private bool IsSmallScreen;
    private bool IsDataLoaded;
    private int ActiveTabIndex;

    bool IsRejectionPopupVisible { get; set; } = false;
    int SelectedMaterialId { get; set; }
    string? RejectionReason { get; set; } = "";

    private GridDevExtremeDataSource<MaterialRequestItemModel>? FulfillmentItems;
    bool IsFulfillmentPopupVisible { get; set; } = false;

    public class FulfillmentTypeItem
    {
        public MaterialRequestItemFulfillmentType Value { get; set; }
        public string Text { get; set; }
    }

    List<FulfillmentTypeItem> FulfillmentTypes = Enum.GetValues<MaterialRequestItemFulfillmentType>().Select(x => new FulfillmentTypeItem
    {
        Value = x,
        Text = x.GetDescription()
    }).ToList();

    Dictionary<int, MaterialRequestItemFulfillmentType> SelectedFulfillmentTypes = new();
    Dictionary<int, decimal> SelectedFulfillmentQuantities = new();
    Dictionary<int, decimal> SelectedRequestedQuantities = new();

    public class FulfillmentPostModel
    {
        public int ItemId { get; set; }
        public string FulfillmentType { get; set; } = string.Empty;
        public decimal RequestedQuantity { get; set; }
        public decimal FulfilledQuantity { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        IsDataLoaded = false;
        await LoadDataAsync();
        IsDataLoaded = true;
    }

    private async Task LoadDataAsync()
    {
        var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
        var response = await client.GetAsync($"api/material-requests/{Id}");

        if (!response.IsSuccessStatusCode)
        {
            NavigationManager.NavigateTo("/material-request/list");
            return;
        }

        Model = await response.Content.ReadFromJsonAsync<MaterialRequestModel>();
        await LoadTabData(ActiveTabIndex);
    }

    private async Task OnActiveTabIndexChanged(int index)
    {
        ActiveTabIndex = index;
        await LoadTabData(index);
    }

    private async Task LoadTabData(int index)
    {
        var client = await ApiClientFactory.CreateAsync(HttpClientFactory.CreateClient("ApiClient"));
        var baseUrl = "https://localhost:7071/api";

        if (index == 0)
        {
            ItemDataSource = new GridDevExtremeDataSource<MaterialRequestItemModel>(
                client,
                NavigationManager.ToAbsoluteUri($"{baseUrl}/material-request-items?materialRequestId={Id}")
            );
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnApproveClick()
    {
        try
        {
            IsDataLoaded = false;
            await InvokeAsync(StateHasChanged);

            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            var client = await ApiClientFactory.CreateAsync(httpClient);

            var response = await client.PutAsync(
                $"https://localhost:7071/api/material-requests/approved/{Id}",
                null
            );

            if (response.IsSuccessStatusCode)
            {
                await LoadDataAsync();
                ToastService.ShowToast(new ToastOptions()
                {
                    Id = "toast",
                    ProviderName = "Overview",
                    ThemeMode = ToastThemeMode.Light,
                    RenderStyle = ToastRenderStyle.Success,
                    Title = "Başarılı",
                    Text = "Talep başarıyla onaylandı.",
                }, RenderToastButton(false));
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                ToastService.ShowToast(new ToastOptions()
                {
                    Id = "toast",
                    ProviderName = "Overview",
                    ThemeMode = ToastThemeMode.Light,
                    RenderStyle = ToastRenderStyle.Danger,
                    Title = "Hata",
                    Text = errorMsg
                }, RenderToastButton(true));
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast(new ToastOptions()
            {
                Id = "toast",
                ProviderName = "Overview",
                ThemeMode = ToastThemeMode.Light,
                RenderStyle = ToastRenderStyle.Danger,
                Title = "Hata",
                Text = ex.Message
            }, RenderToastButton(true));
        }
        finally
        {
            IsDataLoaded = true;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task OnDemandFulfillmentClick()
    {
        if (Model == null) return;

        try
        {
            IsDataLoaded = false;
            SelectedFulfillmentQuantities.Clear();
            SelectedRequestedQuantities.Clear();
            SelectedFulfillmentTypes.Clear();

            await InvokeAsync(StateHasChanged);

            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            var client = await ApiClientFactory.CreateAsync(httpClient);
            var baseUrl = "https://localhost:7071/api";

            FulfillmentItems = new GridDevExtremeDataSource<MaterialRequestItemModel>(
                client,
                NavigationManager.ToAbsoluteUri($"{baseUrl}/material-request-items?materialRequestId={Id}")
            );

            IsFulfillmentPopupVisible = true;
        }
        catch (Exception ex)
        {
            ToastService.ShowToast(new ToastOptions
            {
                Id = "toast",
                ProviderName = "Overview",
                ThemeMode = ToastThemeMode.Light,
                RenderStyle = ToastRenderStyle.Danger,
                Title = "Hata",
                Text = ex.Message
            });
        }
        finally
        {
            IsDataLoaded = true;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task OnConfirmFulfillment()
    {
        try
        {
            IsDataLoaded = false;
            IsFulfillmentPopupVisible = false;

            var postData = SelectedFulfillmentTypes.Select(x => new
            {
                ItemId = x.Key,
                FulfillmentType = x.Value,
                FulfilledQuantity = SelectedFulfillmentQuantities.ContainsKey(x.Key)
                                    ? SelectedFulfillmentQuantities[x.Key]
                                    : 0,
                RequestedQuantity = SelectedRequestedQuantities.ContainsKey(x.Key)
                                    ? SelectedRequestedQuantities[x.Key]
                                    : 0
            }).ToList();

            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            var client = await ApiClientFactory.CreateAsync(httpClient);

            var response = await client.PutAsJsonAsync($"api/material-requests/fulfill-items", postData);

            if (response.IsSuccessStatusCode)
            {
                await LoadDataAsync();
                ToastService.ShowToast(new ToastOptions
                {
                    Id = "toast",
                    ProviderName = "Overview",
                    ThemeMode = ToastThemeMode.Light,
                    RenderStyle = ToastRenderStyle.Success,
                    Title = "Başarılı",
                    Text = "Talep başarıyla karşılandı.",
                });
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast(new ToastOptions
            {
                Id = "toast",
                ProviderName = "Overview",
                ThemeMode = ToastThemeMode.Light,
                RenderStyle = ToastRenderStyle.Danger,
                Title = "Hata",
                Text = ex.Message
            });
        }
        finally
        {
            IsDataLoaded = true;
        }
    }

    private RenderFragment RenderToastButton(bool isError) =>
        @<div class="d-flex gap-2">
        <DxButton Click="@(isError? OnPopupError : OnPopupOk)"
                  RenderStyle="@(isError ? ButtonRenderStyle.Danger : ButtonRenderStyle.Success)">Kapat</DxButton>
    </div>;

    private void OnPopupOk()
    {
        NavigationManager.NavigateTo("/material-request/list");
    }
    private void OnPopupError() { }

    private Task OnRejectClick()
    {
        if (Model != null)
        {
            SelectedMaterialId = Model.Id;
            RejectionReason = string.Empty;
            IsRejectionPopupVisible = true;
        }
        return Task.CompletedTask;
    }

    void OnCancelRejection() => IsRejectionPopupVisible = false;

    async Task OnConfirmRejection()
    {
        try
        {
            IsDataLoaded = false;
            IsRejectionPopupVisible = false;
            await InvokeAsync(StateHasChanged);
            var httpClient = HttpClientFactory.CreateClient("ApiClient");
            var client = await ApiClientFactory.CreateAsync(httpClient);

            var model = new { Id = SelectedMaterialId, RejectionReason = RejectionReason };

            var response = await client.PutAsJsonAsync($"https://localhost:7071/api/material-requests/rejection", model);

            if (response.IsSuccessStatusCode)
            {
                await LoadDataAsync();
                ToastService.ShowToast(new ToastOptions()
                {
                    Id = "toast",
                    ProviderName = "Overview",
                    ThemeMode = ToastThemeMode.Light,
                    RenderStyle = ToastRenderStyle.Success,
                    Title = "Başarılı",
                    Text = "Talep reddedildi.",
                }, RenderToastButton(false));
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                ToastService.ShowToast(new ToastOptions()
                {
                    Id = "toast",
                    ProviderName = "Overview",
                    ThemeMode = ToastThemeMode.Light,
                    RenderStyle = ToastRenderStyle.Danger,
                    Title = "Hata",
                    Text = errorMsg
                }, RenderToastButton(true));
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowToast(new ToastOptions()
            {
                Id = "toast",
                ProviderName = "Overview",
                ThemeMode = ToastThemeMode.Light,
                RenderStyle = ToastRenderStyle.Danger,
                Title = "Hata",
                Text = ex.Message
            }, RenderToastButton(true));
        }
        finally
        {
            IsDataLoaded = true;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void NavigateBack() => NavigationManager.NavigateTo("/material-request/list");
}
