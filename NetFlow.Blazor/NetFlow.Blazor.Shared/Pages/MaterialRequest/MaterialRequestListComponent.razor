@implements IDisposable
@inject NavigationManager NavigationManager
@inject IApiClientFactory ApiClientFactory
@inject IHttpClientFactory HttpClientFactory

<div class="content-root">
    <div class="card toolbar">
        <DxToolbar Title="@Title" ItemRenderStyleMode="ToolbarRenderStyleMode.Plain">

            <DxToolbarItem Text="@StatusFilterValue" RenderStyleMode="ToolbarItemRenderStyleMode.Plain">
                <Items>
                    <DxToolbarItem Text="Tümü" Click="FilterByStatus" />
                    @foreach (var status in StatusList)
                    {
                        <DxToolbarItem Text="@status" Click="FilterByStatus" />
                    }
                </Items>
            </DxToolbarItem>
            <DxToolbarItem Text="Talep Oluþtur"
                           Tooltip="Yeni Talep Ekle"
                           Alignment="ToolbarItemAlignment.Right"
                           Click="OnAddClick"
                           IconCssClass="add-icon icon medium-icon"
                           RenderStyleMode="ToolbarItemRenderStyleMode.Plain" />
            <DxToolbarItem Tooltip="Column Chooser"
                           Alignment="ToolbarItemAlignment.Right"
                           Click="OnColumnChooserItemClick"
                           IconCssClass="column-chooser-icon icon medium-icon" />

            <DxToolbarItem Text="Dýþarý Aktar"
                           Alignment="ToolbarItemAlignment.Right"
                           IconCssClass="export-icon icon medium-icon">
                <Items>
                    <DxToolbarItem Text="Tüm verileri Excel'e aktar" Click="ExportAllDataToExcel" />
                    <DxToolbarItem Text="Seçili satýrlarý Excel'e aktar" Click="ExportSelectedRowsToExcel" />
                    <DxToolbarItem Text="Tüm verileri CSV'ye aktar" Click="ExportAllDataToCsv" />
                    <DxToolbarItem Text="Tüm verileri PDF'e aktar" Click="ExportAllDataToPdf" />
                </Items>
            </DxToolbarItem>

            <DxToolbarItem Alignment="ToolbarItemAlignment.Right"
                           CssClass="search-textbox-item"
                           Tooltip="Search">
                <Template>
                    <DxSearchBox CssClass="search-textbox"
                                 NullText="Ara"
                                 BindValueMode="BindValueMode.OnInput"
                                 ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                 @bind-Text="SearchText" />
                </Template>
            </DxToolbarItem>



            <DxToolbarItem Tooltip="Refresh"
                           Click="LoadGridDataAsync"
                           BeginGroup="true"
                           Alignment="ToolbarItemAlignment.Right"
                           IconCssClass="refresh-icon icon medium-icon" />
        </DxToolbar>
    </div>

    <div class="material-request-list-root h-100">
        <DxGrid @ref="Grid"
                Data="Data"
                KeyFieldName="Id"
                CssClass="material-request-list"
                style="height:100%;"
                SearchText="@SearchText"
                ColumnResizeMode="GridColumnResizeMode.ColumnsContainer"
                ShowAllRows="true"
                VirtualScrollingEnabled="true"
                HighlightRowOnHover="true"
                RowClick="OnRowClick">

            <Columns>
                <DxGridSelectionColumn Width="70px" />

                <DxGridDataColumn Caption="Id" FieldName="Id" Visible="false" />
                <DxGridDataColumn Caption="Talep No" FieldName="RequestNo">
                    <CellDisplayTemplate>
                        <a href="javascript:void(0);"
                           style="font-weight:bold;color:#0056b3"
                           @onclick="() => OpenDetails((MaterialRequestModel)context.DataItem)"
                           @onclick:stopPropagation>
                            @context.Value
                        </a>
                    </CellDisplayTemplate>
                </DxGridDataColumn>

                <DxGridDataColumn Caption="Talep Türü" FieldName="RequestType" Width="120px">
                    <CellDisplayTemplate>
                        <span class="status-badge">
                            @(((MaterialRequestModel)context.DataItem).RequestType.GetDescription())
                        </span>
                    </CellDisplayTemplate>
                </DxGridDataColumn>
                <DxGridDataColumn Caption="Öncelik" FieldName="Priority" Width="120px">
                    <CellDisplayTemplate>
                        <span class="status-badge">
                            @(((MaterialRequestModel)context.DataItem).Priority.GetDescription())
                        </span>
                    </CellDisplayTemplate>
                </DxGridDataColumn>
                <DxGridDataColumn Caption="Durum" FieldName="Status" Width="120px">
                    <CellDisplayTemplate>
                        <span class="status-badge">
                            @(((MaterialRequestModel)context.DataItem).Status.GetDescription())
                        </span>
                    </CellDisplayTemplate>
                </DxGridDataColumn>
                <DxGridDataColumn Caption="Talep Eden Bölüm" FieldName="RequestedDepartment" />
                <DxGridDataColumn Caption="Atayan Kullanýcý" FieldName="RequestedByUser" />
                <DxGridDataColumn Caption="Atanan Kullanýcý" FieldName="AssignedToUser" />
                <DxGridDataColumn Caption="Atanan Departman" FieldName="AssignedDepartment" />
                <DxGridDataColumn Caption="Onaylayan Kullanýcý" FieldName="ApprovedByUser" />
                <DxGridDataColumn Caption="Talep Tarihi" FieldName="RequestDate" />
                <DxGridDataColumn Caption="Gerekli Tarih" FieldName="RequiredDate" />
                <DxGridDataColumn Caption="Açýklama" FieldName="Description" />
                <DxGridDataColumn Caption="Onay Tarihi" FieldName="ApprovalDate" Visible="false" />
                <DxGridDataColumn Caption="Kaynak Referans" FieldName="SourceType" Width="120px">
                    <CellDisplayTemplate>
                        <span class="status-badge">
                            @(((MaterialRequestModel)context.DataItem).SourceType.GetDescription())
                        </span>
                    </CellDisplayTemplate>
                </DxGridDataColumn>
            </Columns>
        </DxGrid>
    </div>
</div>

@code {

    CancellationTokenSource disposalTokenSource = new();
    [Parameter] public string Title { get; set; } = "Malzeme Talepleri";
    [Parameter] public string? RequestParameter { get; set; }
    

    private GridDevExtremeDataSource<MaterialRequestModel> Data = null!;
    private IGrid? Grid;
    private string? SearchText;
    string StatusFilterValue { get; set; } = "Tümü";
    string[] StatusList =
    {
        "Reddedildi",
        "Beklemede",
        "Onaylandý"
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        await LoadGridDataAsync();
    }

    async Task LoadGridDataAsync()
    {
        var client = await ApiClientFactory.CreateAsync(
            HttpClientFactory.CreateClient("ApiClient"));

        var baseUrl = "https://localhost:7071/api/material-requests";

        var url = RequestParameter!=null
            ? $"{baseUrl}/{RequestParameter}"
            : baseUrl;

        Data = new GridDevExtremeDataSource<MaterialRequestModel>(
            client,
            NavigationManager.ToAbsoluteUri(url));

        Grid?.Reload();
        await InvokeAsync(StateHasChanged);
    }

    void FilterByStatus(ToolbarItemClickEventArgs item)
    {
        StatusFilterValue = item.Info.Text;

        Grid!.FilterBy(
            "Status",
            GridFilterRowOperatorType.Equal,
            StatusFilterValue != "Tümü" ? StatusFilterValue : null);
    }

    void OnColumnChooserItemClick(ToolbarItemClickEventArgs e)
        => Grid!.ShowColumnChooser();

    Task ExportAllDataToExcel()
        => Grid!.ExportToXlsxAsync("MalzemeTalepleri");

    Task ExportSelectedRowsToExcel()
        => Grid!.ExportToXlsxAsync("SeciliMalzemeTalepleri",
            new GridXlExportOptions { ExportSelectedRowsOnly = true });

    Task ExportAllDataToCsv()
        => Grid!.ExportToCsvAsync("MalzemeTalepleri");

    Task ExportSelectedRowsToCsv()
        => Grid!.ExportToCsvAsync("SeciliMalzemeTalepleri",
            new GridCsvExportOptions { ExportSelectedRowsOnly = true });

    Task ExportAllDataToPdf()
        => Grid!.ExportToPdfAsync("MalzemeTalepleri");

    Task ExportSelectedRowsToPdf()
        => Grid!.ExportToPdfAsync("SeciliMalzemeTalepleri",
            new GridPdfExportOptions { ExportSelectedRowsOnly = true });

    void OnRowClick(GridRowClickEventArgs args)
    {
        var item = (MaterialRequestModel)Grid!.GetDataItem(args.VisibleIndex);
        NavigationManager.NavigateTo($"/material-request/details/{item.Id}");
    }

    void OpenDetails(MaterialRequestModel item)
        => NavigationManager.NavigateTo($"/material-request/details/{item.Id}");

    void OnAddClick(ToolbarItemClickEventArgs e)
    => NavigationManager.NavigateTo("/material-request/create");

    void IDisposable.Dispose()
    {
        disposalTokenSource.Cancel();
        disposalTokenSource.Dispose();
    }
}
